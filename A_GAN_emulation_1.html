if (!function_exists('ganemulator_img2img')) {
  function ganemulator_img2img(WP_REST_Request $req) {

    list($body, $err) = ganemulator_read_json_body($req);
    if ($err) return ganemulator_json(['ok'=>false,'error'=>$err], 400);

    if (empty($body['image'])) {
      return ganemulator_json(['ok'=>false,'error'=>'missing_image'], 400);
    }

    $api_key = ganemulator_require_key();
    if (!$api_key) {
      return ganemulator_json(['ok'=>false,'error'=>'replicate_api_key_not_set'], 400);
    }

    // --- INTENSITY PRESET (GAN-like) ---
    $prompt   = isset($body['prompt']) ? (string)$body['prompt'] : 'uncanny synthetic amalgamation';
    $negative = 'text, watermark, logo, frame, UI, oversharpen, jpeg artifacts, plastic skin';

    $strength = isset($body['strength']) ? floatval($body['strength']) : 0.82;
    $strength = max(0.6, min(0.95, $strength));

    $steps    = 42;
    $guidance = 7.5;

    // Optional seed (kept random if not provided)
    $seed = isset($body['seed']) ? intval($body['seed']) : null;

    $payload = [
      "version" => GANEMULATOR_REPLICATE_VERSION,
      "input" => [
        "image" => $body['image'],
        "prompt" => $prompt,
        "negative_prompt" => $negative,
        "strength" => $strength,
        "num_inference_steps" => $steps,
        "guidance_scale" => $guidance,
      ]
    ];

    if ($seed !== null) {
      $payload["input"]["seed"] = $seed;
    }

    $resp = wp_remote_post('https://api.replicate.com/v1/predictions', [
      'headers' => [
        'Authorization' => 'Token ' . $api_key,
        'Content-Type'  => 'application/json',
      ],
      'body'    => wp_json_encode($payload),
      'timeout' => 60,
    ]);

    if (is_wp_error($resp)) {
      return ganemulator_json(['ok'=>false,'error'=>$resp->get_error_message()], 500);
    }

    $raw  = wp_remote_retrieve_body($resp);
    $json = json_decode($raw, true);

    if (!is_array($json)) {
      return ganemulator_json(['ok'=>false,'error'=>'replicate_non_json'], 502);
    }

    return ganemulator_json(['ok'=>true,'prediction'=>$json], 200);
  }
}