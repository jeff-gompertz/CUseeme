<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>6Cards â€” Diptych Layout (Full-Height Drag Panels)</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    background: black; /* fallback, not visible under canvas */
  }
  canvas {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
  }
</style>
</head>
<body>
<canvas id="c"></canvas>

<!-- Invisible Click-to-Advance Overlay -->
<div id="nextPageOverlay"></div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){
  // full-bleed canvas that always matches the visible viewport
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// optional: helps on iPad Safari when orientation or browser bars change height
window.addEventListener("orientationchange", () => {
  setTimeout(resize, 500);
});

/* === Keyword(s) for filtering videos === */
const FILTER_KEYWORDS = ["ghost","puppet"];

/* === Load videos from WordPress Media Library === */
async function loadVideos(){
  const MEDIA_API = "https://art.jeffgompertz.site/wp-json/wp/v2/media?per_page=50";
  try{
    const r = await fetch(MEDIA_API);
    const d = await r.json();
    console.log("ðŸ“¦ Raw media items:", d.length);

    const filtered = d.filter(m=>{
      const title   = (m.title?.rendered || "").toLowerCase();
      const caption = (m.caption?.rendered || "").replace(/<[^>]*>/g,"").toLowerCase();
      const desc    = (m.description?.rendered || "").replace(/<[^>]*>/g,"").toLowerCase();
      const url     = (m.source_url || "").toLowerCase();
      const kwHit   = FILTER_KEYWORDS.some(k=>title.includes(k)||caption.includes(k)||desc.includes(k)||url.includes(k));
      const mp4     = m.source_url && /\.mp4(\?.*)?$/i.test(m.source_url);
      return mp4 && kwHit;
    });

    console.log(`ðŸŽ¯ Filtered videos: ${filtered.length}`);

    const vids=[];
    for(const m of filtered){
      const v=document.createElement("video");
      v.src=m.source_url;
      v.loop=true; v.muted=true; v.playsInline=true; v.preload="auto";
      v.style.display="none";
      document.body.appendChild(v);
      await new Promise(res=>{
        const ok=()=>res();
        v.oncanplay=ok; v.onerror=ok; setTimeout(ok,1500);
      });
      v.play().catch(()=>{});
      vids.push(v);
    }
    return vids;
  }catch(e){console.warn("Video load error:",e);return[];}
}

/* === iOS playback unlock === */
function startVideos(){ document.querySelectorAll("video").forEach(v=>v.play().catch(()=>{})); }
addEventListener("touchstart", startVideos, { once:true });
addEventListener("click", startVideos, { once:true });

/* === Card setup (diptych layout) === */

/* === Card / Panel setup (diptych with adjustable horizontal stagger) === */

// adjust this number to control horizontal misalignment

/* === Card / Panel setup (diptych, inward overlap at center) === */
let cards = [];
const NUM_CARDS = 6;

// tweak these two values to control overlap and randomness
const CENTER_OVERLAP = 120;   // how far inward panels push toward center
const STAGGER_X = 40;         // random horizontal jitter for organic feel

function initCards(vids){
  const W = canvas.width, H = canvas.height;
  const w = W / 2;   // each panel nominally half screen width
  const h = H;
  cards = [];

  for (let i = 0; i < NUM_CARDS; i++) {
    const side = i < NUM_CARDS / 2 ? "left" : "right";
    const yBase = 0;
    const inward = (Math.random() - 0.5) * STAGGER_X; // small random wobble

    // push both sides toward the center for overlap
    const xBase = side === "left"
      ? 0 + CENTER_OVERLAP + inward      // move rightward from left edge
      : (W / 2) - CENTER_OVERLAP + inward; // move leftward from right edge

    cards.push({
      x: xBase,
      y: yBase,
      w, h,
      side,
      vid: vids.length ? vids[i % vids.length] : null,
      dragging: false,
      offsetX: 0,
      offsetY: 0
    });
  }
}

/* === Draw helper === */
function drawVideoCover(vid,x,y,w,h){
  const iw = vid.videoWidth || vid.width;
  const ih = vid.videoHeight || vid.height;
  if(!iw||!ih) return;
  const r = Math.max(w/iw, h/ih);
  const nw = iw*r, nh = ih*r;
  const ox = x+(w-nw)/2, oy = y+(h-nh)/2;
  ctx.drawImage(vid, ox, oy, nw, nh);
}

/* === Render loop === */
function render(){
  ctx.fillStyle="rgba(0,0,0,0.05)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for(const c of cards){
    if(c.vid && c.vid.readyState>=2){
      ctx.globalAlpha=0.35;
      drawVideoCover(c.vid,c.x,c.y,c.w,c.h);
      ctx.globalAlpha=1;
    }else{
      ctx.fillStyle="rgba(255,255,255,0.25)";
      ctx.fillRect(c.x,c.y,c.w,c.h);
    }
  }
  requestAnimationFrame(render);
}

/* === Drag behavior, constrained === */
let active=null;
function pointerDown(e){
  const rect=canvas.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
  const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
  for(let i=cards.length-1;i>=0;i--){
    const c=cards[i];
    if(x>c.x && x<c.x+c.w && y>c.y && y<c.y+c.h){
      c.dragging=true;
      c.offsetX=x-c.x; c.offsetY=y-c.y;
      active=c; break;
    }
  }
}
function pointerMove(e){
  if(!active) return;
  const rect=canvas.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-rect.left;
  const y=(e.touches?e.touches[0].clientY:e.clientY)-rect.top;
  active.x = x - active.offsetX;
  active.y = y - active.offsetY;
  // constrain within viewport
  active.x = Math.max(0, Math.min(canvas.width - active.w, active.x));
  active.y = Math.max(0, Math.min(canvas.height - active.h, active.y));
}
function pointerUp(){
  if(active){ active.dragging=false; active=null; }
}
canvas.addEventListener("mousedown",pointerDown);
canvas.addEventListener("mousemove",pointerMove);
canvas.addEventListener("mouseup",pointerUp);
canvas.addEventListener("touchstart",pointerDown);
canvas.addEventListener("touchmove",pointerMove);
canvas.addEventListener("touchend",pointerUp);

/* === Invisible Click-to-Advance Overlay Logic === */
const NEXT_PAGE_URL = "https://jeff-gompertz.github.io/CUseeme/6cards_VerticalPanelSceneDissolve2.html";
const overlay = document.getElementById("nextPageOverlay");
Object.assign(overlay.style, {
  position: "fixed",
  top: "0", left: "0",
  width: "100vw", height: "100vh",
  zIndex: "99999",
  background: "transparent",
  cursor: "pointer"
});
overlay.addEventListener("click", ()=> window.location.href = NEXT_PAGE_URL);
overlay.addEventListener("touchstart", ()=> window.location.href = NEXT_PAGE_URL);

/* === Boot === */
(async function(){
  const vids = await loadVideos();
  if(!vids.length){ console.warn("No videos found"); return; }
  initCards(vids);
  render();
})();
</script>
</body>
</html>
