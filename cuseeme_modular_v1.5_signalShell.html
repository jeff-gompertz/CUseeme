<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CUSeeMe Modular v1.6 — Signal Shell</title>

<style>
/* =========================================================
   [L6: GLOBAL STYLE SYSTEM]
========================================================= */
:root{
  --base-bg: #ffffff;
  --ui-fg:  #0a0a0a;
  --glass:  rgba(255,255,255,0.22);
  --glass-b: rgba(0,0,0,0.18);
  --ticker-color: #FF4433;
  --mini-bezel: #d7d7d7;
  --mini-label: #7a7a7a;
  --accent-violet: #a687ff;
}

/* =========================================================
   [L0: BASE LAYER — CAMERA]
========================================================= */
html,body{
  margin:0; height:100%; overflow:hidden; background:var(--base-bg);
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  color: var(--ui-fg);
}
#cameraMain{
  position: fixed; inset: 0; object-fit: cover;
  transform: scaleX(-1);
  z-index: 0;
}

/* =========================================================
   [L1: HUD — upper-right frosted controls]
========================================================= */
#hud{
  position: fixed; top: 14px; right: 14px; z-index: 10;
  display: grid; gap: 8px; grid-auto-rows: min-content;
  background: var(--glass); backdrop-filter: blur(10px);
  border: 1px solid var(--glass-b); border-radius: 12px;
  padding: 10px; min-width: 220px;
}
#hud h1{margin: 2px 0 6px; font-size: 12px; letter-spacing:.06em; opacity:.7;}
.hud-row{ display:flex; gap:8px; flex-wrap:wrap; }

.hud-btn{
  appearance:none; border:1px solid var(--glass-b); border-radius:10px;
  background: rgba(255,255,255,0.35);
  padding: 6px 10px; font-size:12px; color:#000; cursor:pointer;
  box-shadow: 0 1px 0 rgba(255,255,255,0.35) inset, 0 6px 16px rgba(0,0,0,0.08);
}
.hud-btn:hover{ background: rgba(255,255,255,0.5); }
.hud-btn.primary{ background: rgba(255,255,255,0.55); font-weight:600; }
#hud.dim { opacity:.15; } #hud.dim:hover { opacity:1; transition:opacity .2s; }

/* =========================================================
   [L3: TICKER — bottom-left, red]
========================================================= */
#ticker{
  position: fixed; left: 12px; bottom: 12px; z-index: 8;
  width: 42vw; max-width: 640px;
  display:flex; flex-direction:column-reverse;
  overflow:hidden; color:var(--ticker-color);
  font-size:1.2rem; line-height:1.3rem; opacity:0.9;
}
.tline{ opacity:.9; margin:0; animation:tlIn .6s ease forwards; }
@keyframes tlIn{ from{opacity:0; transform:translateY(8px);} to{opacity:.9; transform:none;} }

/* =========================================================
   [L4: INPUT PROMPT — centered overlay]
========================================================= */
#promptWrap{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  pointer-events:none; z-index:9;
}
#promptBox{
  display:flex; align-items:center; gap:6px;
  background:rgba(255,255,255,0.25); backdrop-filter:blur(8px);
  border-radius:10px; padding:8px 12px;
}
#input{
  background:transparent; border:none; outline:none;
  color:#111; font-size:14px; width:220px;
  pointer-events:auto;
}

/* =========================================================
   [L5: FLOATING MINI-FEED — draggable window]
========================================================= */
#miniWin{
  position: fixed;
  left: 6vw; top: 10vh; z-index: 7;
  width: 40vw; aspect-ratio: 4/3;
  display: none;
  border: 1px solid #bfbfbf;
  border-radius: 12px;
  background: linear-gradient(#efefef,#dbdbdb);
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  overflow:hidden;
  cursor: grab;
}
#miniWin:active{ cursor: grabbing; }
#miniBar{
  background:rgba(255,255,255,0.35);
  font-size:11px; padding:4px 8px; cursor:grab;
  display:flex; justify-content:space-between; align-items:center;
}
#miniInner video{ width:100%; height:100%; object-fit:cover; }
</style>
</head>

<body>
<video id="cameraMain" autoplay muted playsinline></video>

<!-- HUD -->
<div id="hud">
  <h1>Signal Shell</h1>
  <div class="hud-row">
    <button class="hud-btn primary" id="btnToggleMini">➕ Mini-Feed</button>
    <button class="hud-btn" id="btnMirrorMain">Mirror Main</button>
    <button class="hud-btn" id="btnMirrorMini" disabled>Mirror Mini</button>
  </div>
  <div class="hud-row">
    <button class="hud-btn" id="btnSignal">Signal Mode</button>
    <button class="hud-btn" id="btnMiniGrow">Mini +</button>
    <button class="hud-btn" id="btnMiniShrink">Mini −</button>
  </div>
  <div class="hud-row"><button class="hud-btn" id="btnReset">Reset</button></div>
</div>

<!-- Ticker -->
<div id="ticker"></div>

<!-- Input -->
<div id="promptWrap">
  <div id="promptBox">
    <input id="input" type="text" placeholder="type here…" spellcheck="false" autocomplete="off" />
  </div>
</div>

<!-- Mini Window -->
<div id="miniWin">
  <div id="miniBar">subject_0001</div>
  <div id="miniInner"><video id="cameraMini" autoplay muted playsinline></video></div>
</div>

<script>
/* =========================================================
   [UTIL] — Add ticker lines
========================================================= */
const ticker=document.getElementById('ticker');
function addTicker(text){
  const line=document.createElement('div');
  line.className='tline';
  line.textContent=text;
  ticker.prepend(line);
  if(ticker.children.length>60)ticker.removeChild(ticker.lastChild);
}

/* Boot diagnostics */
['link /optical established','loopback handshake ok','ui shell ready','ticker: online']
.forEach((m,i)=>setTimeout(()=>addTicker(m),300*i));

/* =========================================================
   [L0] CAMERA INIT
========================================================= */
const vMain=document.getElementById('cameraMain');
const vMini=document.getElementById('cameraMini');
(async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    vMain.srcObject=stream;
    vMini.srcObject=stream;
    addTicker('camera stream: granted');
  }catch(e){ addTicker('⚠ camera denied'); }
})();

/* =========================================================
   [L4] INPUT — echo text to ticker
========================================================= */
const input=document.getElementById('input');
function processInput(val){
  val=val.trim(); if(!val)return;
  addTicker('> '+val); input.value='';
  const replies=[
    `acknowledged: "${val}"`,
    `note: "${val}" logged`,
    `latency ${(Math.random()*0.6+0.2).toFixed(2)}s`,
    `signal correlation ${Math.floor(Math.random()*100)}%`
  ];
  setTimeout(()=>addTicker('< '+replies[Math.floor(Math.random()*replies.length)]),700);
}
input.addEventListener('keydown',e=>{
  if(e.key==='Enter'){e.preventDefault();processInput(input.value);}
});
input.addEventListener('input',e=>{
  if(e.inputType==='insertLineBreak'){e.preventDefault?.();processInput(input.value);}
});

/* =========================================================
   [L1] HUD FUNCTIONS
========================================================= */
const miniWin=document.getElementById('miniWin');
const btnMini=document.getElementById('btnToggleMini');
const btnMirrorMain=document.getElementById('btnMirrorMain');
const btnMirrorMini=document.getElementById('btnMirrorMini');
const btnSignal=document.getElementById('btnSignal');
const btnGrow=document.getElementById('btnMiniGrow');
const btnShrink=document.getElementById('btnMiniShrink');
const btnReset=document.getElementById('btnReset');

btnMini.onclick=()=>{
  const on=miniWin.style.display!=='block';
  miniWin.style.display=on?'block':'none';
  btnMirrorMini.disabled=!on;
  addTicker(on?'mini-feed: shown':'mini-feed: hidden');
};
let mirrorMain=true,mirrorMini=true;
btnMirrorMain.onclick=()=>{
  mirrorMain=!mirrorMain;
  vMain.style.transform=mirrorMain?'scaleX(-1)':'none';
  addTicker(`mirror main: ${mirrorMain?'on':'off'}`);
};
btnMirrorMini.onclick=()=>{
  mirrorMini=!mirrorMini;
  vMini.style.transform=mirrorMini?'scaleX(-1)':'none';
  addTicker(`mirror mini: ${mirrorMini?'on':'off'}`);
};
btnSignal.onclick=()=>{
  document.body.classList.toggle('signal');
  addTicker(`signal mode: ${document.body.classList.contains('signal')?'on':'off'}`);
};
btnGrow.onclick=()=>{miniWin.style.width=(miniWin.offsetWidth*1.1)+'px';};
btnShrink.onclick=()=>{miniWin.style.width=(miniWin.offsetWidth*0.9)+'px';};
btnReset.onclick=()=>{
  document.body.classList.remove('signal');
  vMain.style.transform='scaleX(-1)';
  vMini.style.transform='scaleX(-1)';
  miniWin.style.left='6vw'; miniWin.style.top='10vh'; miniWin.style.width='40vw';
  addTicker('reset: shell defaults');
};

/* =========================================================
   [L5] MINI WINDOW DRAG — unified pointer/touch
========================================================= */
(function(){
  let isDragging=false,startX,startY,startLeft,startTop;
  function startDrag(e){
    isDragging=true;
    const rect=miniWin.getBoundingClientRect();
    startLeft=rect.left; startTop=rect.top;
    startX=e.touches?e.touches[0].clientX:e.clientX;
    startY=e.touches?e.touches[0].clientY:e.clientY;
    document.addEventListener('pointermove',onDrag);
    document.addEventListener('pointerup',stopDrag);
    document.addEventListener('touchmove',onDrag,{passive:false});
    document.addEventListener('touchend',stopDrag);
  }
  function onDrag(e){
    if(!isDragging)return;
    const cx=e.touches?e.touches[0].clientX:e.clientX;
    const cy=e.touches?e.touches[0].clientY:e.clientY;
    miniWin.style.left=(startLeft+(cx-startX))+'px';
    miniWin.style.top=(startTop+(cy-startY))+'px';
    e.preventDefault?.();
  }
  function stopDrag(){
    isDragging=false;
    document.removeEventListener('pointermove',onDrag);
    document.removeEventListener('pointerup',stopDrag);
    document.removeEventListener('touchmove',onDrag);
    document.removeEventListener('touchend',stopDrag);
  }
  document.getElementById('miniBar').addEventListener('pointerdown',startDrag);
  document.getElementById('miniBar').addEventListener('touchstart',startDrag,{passive:false});
})();
</script>
</body>
</html>
