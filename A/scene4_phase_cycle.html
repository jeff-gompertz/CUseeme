<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CUSeeMe — Scene 4 (Phase Cycle)</title>

<!-- Font Awesome (icons for header) -->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta1/css/all.css">

<style>
/* =========================================================
Scene 4 — Phase Cycle (MetaColor + Neumorphic System)
========================================================= */

html,body {
  margin: 0;
  height: 100%;
  background: #e5e9f4;  /* MetaColor neutral base */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

/* ======= Header Bar (shared neumorphic style) ======= */
header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #e5e9f4;
  box-shadow: 0 5px 10px rgba(0,0,0,0.05);
  z-index: 100;
  display: flex;
  justify-content: center;
  padding: 1rem 0;
}

.buttons {
  display: grid;
  grid-template-columns: repeat(6, minmax(60px, 1fr));
  gap: 1rem;
  width: min(90vw, 500px);
}

button.neumorphic {
  border: 0.5rem solid transparent;
  border-radius: 1rem;
  color: hsl(0 0% 10%);
  background: none;
  display: grid;
  place-content: center;
  gap: 0.5rem;
  --shadow:
    -.5rem -.5rem 1rem hsl(0 0% 100% / .75),
    .5rem .5rem 1rem hsl(0 0% 50% / .5);
  box-shadow: var(--shadow);
  outline: none;
  transition: all 0.1s;
}

button.neumorphic:hover,
button.neumorphic:focus-visible {
  color: hsl(10 80% 50%);
  scale: 1.05;
}

button.neumorphic:active,
button.neumorphic.active {
  box-shadow:
    var(--shadow),
    inset .5rem .5rem 1rem hsl(0 0% 50% / .5),
    inset -.5rem -.5rem 1rem hsl(0 0% 100% / .75);
  color: hsl(10 80% 50%);
}

button.neumorphic > i { font-size: 20px; }
button.neumorphic > span { font-size: 12px; }

@media (max-width: 600px) {
  .buttons {
    grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
    width: 95vw;
    gap: 0.5rem;
  }
  button.neumorphic > i { font-size: 16px; }
  button.neumorphic > span { font-size: 10px; }
}

/* ======= Main Canvas Zone ======= */
main {
  flex: 1;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding-top: 110px; /* space for header */
}

#phaseContainer {
  position: relative;
  width: 90vw;
  max-width: 900px;
  aspect-ratio: 14 / 9;
  overflow: hidden;
  border-radius: 14px;
  background: rgba(255,255,255,0.12);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.5),
              0 12px 40px rgba(0,0,0,0.15);
  display: flex;
  justify-content: space-evenly;
  align-items: stretch;
}

.phasePanel {
  flex: 1;
  margin: 0 4px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.4);
  backdrop-filter: blur(12px) saturate(1.2);
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,0.6),
    0 12px 35px rgba(0,0,0,0.2);
  overflow: hidden;
  position: relative;
}

.phasePanel canvas {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
</style>
</head>

<body>

<!-- ======= Header Buttons ======= -->
<header>
  <div class="buttons">
    <button class="neumorphic" id="btnPhase"><i class="fa-light fa-waveform"></i><span>Phase Δ</span></button>
    <button class="neumorphic" id="btnOffset"><i class="fa-light fa-aratom"></i><span>Offset</span></button>
    <button class="neumorphic" id="btnCycle"><i class="fa-light fa-circle-notch"></i><span>Cycle</span></button>
    <button class="neumorphic" id="btnFlip"><i class="fa-light fa-camera-rotate"></i><span>Cam ↺</span></button>
    <button class="neumorphic" id="btnNext"><i class="fa-light fa-arrow-right"></i><span>Next</span></button>
    <button class="neumorphic" id="btnReturn"><i class="fa-light fa-arrow-left"></i><span>Return</span></button>
  </div>
</header>

<!-- ======= Main Phase Container ======= -->
<main>
  <div id="phaseContainer"></div>
</main>

<script>
/* =========================================================
Scene 4 — Phase Cycle Script
========================================================= */

const container = document.getElementById('phaseContainer');
const NUM_PANELS = 6;
let phaseDelay = 50;     // base ms delay
let blendMode = 'screen';
let phaseOffset = 0;

// Create panels
const panels = [];
for (let i=0; i<NUM_PANELS; i++) {
  const div = document.createElement('div');
  div.className = 'phasePanel';
  const cv = document.createElement('canvas');
  div.appendChild(cv);
  container.appendChild(div);
  panels.push(cv);
}

// Setup video feed
let video = document.createElement('video');
video.autoplay = true;
video.muted = true;
video.playsInline = true;
navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
  .then(stream => video.srcObject = stream)
  .catch(err => console.error('camera error', err));

// Canvas draw loop
const ctxs = panels.map(cv => cv.getContext('2d'));
function drawLoop() {
  if (video.readyState >= 2) {
    ctxs.forEach((ctx, i) => {
      const delay = i * phaseDelay;
      setTimeout(() => {
        ctx.globalCompositeOperation = blendMode;
        ctx.drawImage(video, 0, 0, ctx.canvas.width, ctx.canvas.height);
      }, delay);
    });
  }
  requestAnimationFrame(drawLoop);
}
drawLoop();

// ====== Buttons ======
document.getElementById('btnPhase').onclick = () => {
  phaseDelay += 50;
  if (phaseDelay > 300) phaseDelay = 50;
  console.log('Phase delay set to', phaseDelay, 'ms');
};

document.getElementById('btnOffset').onclick = () => {
  phaseOffset = (phaseOffset + 1) % 3;
  container.style.transform = `translateX(${phaseOffset * 2}px)`;
};

document.getElementById('btnCycle').onclick = () => {
  const modes = ['screen', 'overlay', 'lighten', 'normal'];
  const idx = (modes.indexOf(blendMode) + 1) % modes.length;
  blendMode = modes[idx];
  console.log('Blend mode:', blendMode);
};

document.getElementById('btnFlip').onclick = async () => {
  let facing = (video.getAttribute('data-facing') === 'user') ? 'environment' : 'user';
  video.setAttribute('data-facing', facing);
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing }, audio: false });
  video.srcObject = stream;
};

document.getElementById('btnNext').onclick = () => {
  window.location.href = 'scene5.html';
};

document.getElementById('btnReturn').onclick = () => {
  window.location.href = 'scene3.html';
};
</script>

</body>
</html>
