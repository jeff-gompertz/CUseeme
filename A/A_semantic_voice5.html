<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CUSeeMe â€” Version B Core</title>

<style>
  :root{
    --bg:#0b0c0e;
    --ink:#f5f5f7;
    --accent:#ff4433;
    --accent2:#3ea6ff;
    --note:#8b8f97;
  }

  html,body{
    margin:0;padding:0;height:100%;
    background:var(--bg);color:var(--ink);
    font-family:"VT323",ui-monospace,monospace;
    overflow:hidden;-webkit-font-smoothing:antialiased;
  }

  /* Center prompt */
  #promptWrap{
    position:fixed;inset:0;display:grid;
    place-items:center;pointer-events:none;z-index:2;
  }
  #promptBox{
    pointer-events:auto;
    display:flex;align-items:center;gap:.5rem;
    padding:.6rem 1rem;font-size:2rem;
    background:rgba(15,15,18,0.82);
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    box-shadow:0 14px 38px rgba(0,0,0,0.75);
  }
  #caret{
    width:.25ch;height:1.3em;background:var(--ink);
    animation:blink 1s step-end infinite;
  }
  @keyframes blink{50%{opacity:0}}

  #input{
    border:0;outline:0;background:transparent;
    color:var(--ink);font:inherit;width:18ch;
  }
  #input::placeholder{color:rgba(255,255,255,0.32)}

  /* Buttons */
  .pill-btn{
    cursor:pointer;border:0;outline:0;
    padding:.32rem .6rem;font-size:1.5rem;
    border-radius:999px;color:var(--ink);
    background:rgba(255,255,255,0.05);
  }
 /* .pill-btn.on{
    background:rgba(255,68,51,0.25);
    box-shadow:0 0 12px rgba(255,68,51,0.45);*/
  
  .pill-btn.on{
    background:rgba(62,166,255,0.18);
    box-shadow:0 0 16px rgba(62,166,255,0.45);
  
  }

  /* Ticker */
  #ticker{
    position:fixed;left:12px;bottom:12px;
    width:min(42vw,560px);max-height:60vh;
    display:flex;flex-direction:column-reverse;
    overflow:hidden;z-index:1;
    font-size:1.15rem;line-height:1.25rem;
  }
  .tline{
    margin:0 0 3px 0;opacity:.95;
    white-space:pre-wrap;
    animation:fadeIn .3s ease-out forwards;
    transition:opacity 60s linear;
  }
  .t-user{color:var(--accent2)}
  .t-sys{color:var(--accent)}
  .t-note{color:var(--note)}
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:.95;transform:translateY(0)}
  }
</style>
</head>
<body>

<div id="promptWrap">
  <div id="promptBox">
    <button id="btnMic" class="pill-btn">ðŸŽ™</button>
    <div id="caret"></div>
    <input id="input" type="text" placeholder="type or speakâ€¦" autocomplete="off" />
    <button id="btnVoice" class="pill-btn on">ðŸ”Š</button>
  </div>
</div>

<div id="ticker"></div>

<script>
/* --- Helpers --- */
const $ = sel => document.querySelector(sel);
const ticker = $('#ticker');

function addLine(txt, cls="t-sys"){
  const div=document.createElement('div');
  div.className="tline "+cls;
  div.textContent=txt;
  ticker.prepend(div);
  if(ticker.children.length>120) ticker.removeChild(ticker.lastChild);
  setTimeout(()=>div.style.opacity=0.18,60000);
}

/* --- Speech Synthesis (clean, non-singing) --- */
let voiceOn=true;
let voicesReady=false;

function waitForVoices(){
  return new Promise(res=>{
    if(voicesReady && speechSynthesis.getVoices().length) return res();
    const id=setInterval(()=>{
      if(speechSynthesis.getVoices().length){
        clearInterval(id);voicesReady=true;res();
      }
    },120);
  });
}

function pickSafeVoice(list){
  const blacklist=/(melody|opera|sing|vocal)/i;
  const safe=list.filter(v=>!blacklist.test(v.name));
  return safe[0] || list[0] || null;
}

async function speak(text){
  if(!voiceOn) return;
  if(!("speechSynthesis" in window)) return;

  await waitForVoices();
  const u=new SpeechSynthesisUtterance(text);
  u.lang="en-US";u.rate=1.0;u.pitch=1.0;u.volume=0.95;
  u.voice=pickSafeVoice(speechSynthesis.getVoices());
  speechSynthesis.speak(u);
}

/* --- iOS unlock --- */
function unlock(){
  try{
    const u=new SpeechSynthesisUtterance(" ");
    speechSynthesis.speak(u);speechSynthesis.cancel();
  }catch(e){}
  window.removeEventListener("touchstart",unlock);
  window.removeEventListener("click",unlock);
}
window.addEventListener("touchstart",unlock,{once:true});
window.addEventListener("click",unlock,{once:true});

/* --- Reply logic --- */
function buildReply(t){
  const x=t.toLowerCase().trim();
  if(x==="hello"||x.startsWith("hi"))
    return "Hello. I'm listening.";
  return "You said: "+t;
}

/* --- Submit (text or voice) --- */
function handleSubmit(raw){
  const t=(raw||"").trim();
  if(!t) return;

  addLine("> "+t,"t-user");
  const reply=buildReply(t);
  addLine("< "+reply,"t-sys");
  speak(reply);
}

/* --- Text input --- */
const input=$("#input");
input.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const v=input.value.trim();
    input.value="";
    handleSubmit(v);
  }
});

/* --- Voice input --- */
const btnMic=$("#btnMic");
const SR=window.SpeechRecognition || window.webkitSpeechRecognition;

let rec=null,listening=false,interim="";

if(!SR){
  btnMic.disabled=true;
  addLine("âš  voice recognition unavailable","t-note");
}else{
  rec=new SR();
  rec.lang="en-US";
  rec.continuous=true;
  rec.interimResults=true;

  rec.onstart=()=>{listening=true;addLine("ðŸŽ¤ mic on â€” listeningâ€¦","t-note");};
  rec.onend  =()=>{listening=false;addLine("â¹ mic off","t-note");};
  rec.onerror=e=>addLine("mic error: "+e.error,"t-note");

  rec.onresult=evt=>{
    let final="";
    interim="";

    for(let i=evt.resultIndex;i<evt.results.length;i++){
      const t=evt.results[i][0].transcript;
      if(evt.results[i].isFinal) final+=t+" ";
      else interim+=t;
    }

    if(interim) input.value=interim;
    if(final.trim()){
      input.value="";
      handleSubmit(final.trim());
    }
  };

  btnMic.addEventListener("click",()=>{
    try{
      if(!listening) rec.start();
      else rec.stop();
    }catch(err){
      addLine("mic toggle error: "+err.message,"t-note");
    }
  });
}

/* --- Voice toggle --- */
const btnVoice=$("#btnVoice");
btnVoice.addEventListener("click",()=>{
  voiceOn=!voiceOn;
  btnVoice.classList.toggle("on",voiceOn);
  btnVoice.textContent=voiceOn?"ðŸ”Š":"ðŸ”‡";
  addLine("voice replies "+(voiceOn?"enabled":"muted"),"t-note");
});

/* --- Startup --- */
addLine("session ready â€” type or press ðŸŽ™ and speak","t-note");
</script>
</body>
</html>
