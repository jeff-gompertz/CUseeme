<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CUSeeMe â€” Version B Clean</title>

<style>
:root{
  --bg:#0b0c0e;
  --ink:#f5f5f7;
  --accent:#ff4433;    /* system red */
  --accent2:#3ea6ff;   /* user blue */
  --note:#8b8f97;

  --glow: rgba(62,166,255,0.45);   /* BLUE glow */
  --glow-bg: rgba(62,166,255,0.18);
}

html,body{
  margin:0;padding:0;height:100%;
  background:var(--bg);
  color:var(--ink);
  font-family:"VT323", ui-monospace, Menlo, Consolas, monospace;
  overflow:hidden;
}

/* ---------------- PROMPT ---------------- */
#promptWrap{
  position:fixed; inset:0;
  display:grid; place-items:center;
  pointer-events:none;
  z-index:10;
}

#promptBox{
  pointer-events:auto;
  display:flex; align-items:center; gap:.55rem;
  padding:.7rem 1.1rem;
  font-size:2rem;
  background:rgba(15,15,18,0.78);
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.10);
  box-shadow:
    0 14px 40px rgba(0,0,0,0.75),
    0 0 0px 1px rgba(255,255,255,0.04);
}

#caret{
  width:.28ch; height:1.3em;
  background:var(--ink);
  animation:blink 1s step-end infinite;
}
@keyframes blink{50%{opacity:0}}

#input{
  border:0; outline:0; background:transparent;
  color:var(--ink); font:inherit; width:17ch;
}
#input::placeholder{ color:rgba(255,255,255,0.35); }

/* ---------------- BUTTONS ---------------- */
.pill-btn{
  border:0; outline:0;
  font:inherit;
  font-size:1.45rem;
  padding:.32rem .65rem;
  border-radius:999px;
  background:rgba(255,255,255,0.07);
  color:var(--ink);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  transition:background .15s, box-shadow .2s, transform .15s;
}
.pill-btn:hover{
  background:rgba(255,255,255,0.16);
}
.pill-btn.on{
  background:var(--glow-bg);
  box-shadow:0 0 16px var(--glow);
}

/* ---------------- TICKER ---------------- */
#ticker{
  position:fixed; left:14px; bottom:14px;
  width:min(46vw,580px);
  max-height:60vh;
  display:flex; flex-direction:column-reverse;
  overflow:hidden;
  font-size:1.14rem; line-height:1.24rem;
}

.tline{ margin:0 0 3px 0; opacity:.96;
  animation:fadeIn .4s ease-out forwards;
  transition:opacity 60s linear;
}
.t-user{ color:var(--accent2); }
.t-sys{ color:var(--accent); }
.t-note{ color:var(--note); }

@keyframes fadeIn{
  from{ opacity:0; transform:translateY(6px);}
  to  { opacity:.96; transform:translateY(0);}
}
</style>
</head>
<body>

<div id="promptWrap">
  <div id="promptBox">
    <button id="btnMic" class="pill-btn" title="Mic">ðŸŽ™</button>
    <div id="caret"></div>
    <input id="input" placeholder="type or speakâ€¦" spellcheck="false" autocomplete="off">
    <button id="btnVoice" class="pill-btn" title="Voice replies">ðŸ”Š</button>
  </div>
</div>

<div id="ticker"></div>

<script>
/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
const ticker = $('#ticker');

function addLine(text, cls="t-sys"){
  const el=document.createElement('div');
  el.className='tline '+cls;
  el.textContent=text;
  ticker.prepend(el);
  while(ticker.children.length>120) ticker.removeChild(ticker.lastChild);
  setTimeout(()=>el.style.opacity=0.18,60000);
}

/* ---------- Speech synthesis ---------- */
let voiceOn=true;
let voicesReady=false;

/* Wait for voices to load */
function waitForVoices(){
  return new Promise(res=>{
    if(voicesReady && speechSynthesis.getVoices().length) return res();
    const id=setInterval(()=>{
      if(speechSynthesis.getVoices().length){
        clearInterval(id);
        voicesReady=true;
        res();
      }
    },120);
  });
}

/* English-only safe voice */
function pickSafeVoice(list){
  if(!list.length) return null;

  const blacklist=/(melody|opera|sing|vocal|song)/i;
  const safe=list.filter(v=>!blacklist.test(v.name));

  const preferred=[
    /samantha/i,
    /google us english/i,
    /neutral/i,
    /news/i,
    /story/i,
    /narrator/i,
    /ava/i,
    /aria/i
  ];

  for(const p of preferred){
    const v=safe.find(v=>p.test(v.name));
    if(v) return v;
  }
  return safe[0]||list[0]||null;
}

async function speak(text){
  if(!voiceOn) return;
  if(!window.speechSynthesis) return;

  await waitForVoices();

  const u=new SpeechSynthesisUtterance(text);
  u.lang="en-US";            /* â† forces ENGLISH */
  u.rate=1.0;
  u.pitch=1.0;
  u.volume=0.9;

  const voices=speechSynthesis.getVoices();
  u.voice=pickSafeVoice(voices);

  speechSynthesis.speak(u);
}

/* ---------- iOS unlock ---------- */
function unlockOnce(){
  try{
    const u=new SpeechSynthesisUtterance(" ");
    speechSynthesis.speak(u);
    speechSynthesis.cancel();
  }catch(e){}
  window.removeEventListener("touchstart",unlockOnce);
  window.removeEventListener("click",unlockOnce);
}
window.addEventListener("touchstart",unlockOnce,{once:true});
window.addEventListener("click",unlockOnce,{once:true});

/* ---------- Build reply ---------- */
function buildReply(t){
  const s=t.toLowerCase().trim();
  if(s==="hello"||s.startsWith("hi")) return "Hello. I'm listening.";
  return "You said: "+t;
}

/* ---------- Submit ---------- */
function handleSubmit(raw){
  const t=(raw||"").trim();
  if(!t) return;
  addLine("> "+t,"t-user");
  const reply=buildReply(t);
  addLine("< "+reply,"t-sys");
  speak(reply);
}

/* ---------- Text input ---------- */
const input=$('#input');
input.addEventListener('keydown',e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const v=input.value.trim();
    input.value="";
    handleSubmit(v);
  }
});

/* ---------- Voice input ---------- */
const btnMic=$('#btnMic');
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;

let rec=null;
let listening=false;
let interim="";

if(!SR){
  addLine("âš  voice recognition unavailable","t-note");
  btnMic.disabled=true;

}else{
  rec=new SR();
  rec.lang="en-US";
  rec.continuous=true;
  rec.interimResults=true;

  rec.onstart=()=>{
    listening=true;
    btnMic.classList.add("on");
    addLine("ðŸŽ¤ mic on â€” listeningâ€¦","t-note");
  };

  rec.onend=()=>{
    listening=false;
    btnMic.classList.remove("on");
    addLine("â¹ mic off","t-note");
  };

  rec.onerror=e=>{
    addLine("mic error: "+e.error,"t-note");
  };

  rec.onresult=evt=>{
    let final="";
    interim="";

    for(let i=evt.resultIndex;i<evt.results.length;i++){
      const txt=evt.results[i][0].transcript;
      if(evt.results[i].isFinal) final+=txt+" ";
      else interim+=txt;
    }

    if(interim) input.value=interim;
    if(final.trim()){
      input.value="";
      handleSubmit(final.trim());
    }
  };

  btnMic.addEventListener("click",()=>{
    try{
      if(!listening) rec.start();
      else rec.stop();
    }catch(err){
      addLine("mic toggle error: "+err.message,"t-note");
    }
  });
}

/* ---------- Voice toggle ---------- */
const btnVoice=$('#btnVoice');
btnVoice.addEventListener('click',()=>{
  voiceOn=!voiceOn;
  btnVoice.classList.toggle("on",voiceOn);
  btnVoice.textContent=voiceOn?"ðŸ”Š":"ðŸ”‡";
  addLine("voice replies "+(voiceOn?"enabled":"muted"),"t-note");
});

/* ---------- Startup ---------- */
addLine("session ready â€” type or press ðŸŽ™ and speak","t-note");
</script>
</body>
</html>
