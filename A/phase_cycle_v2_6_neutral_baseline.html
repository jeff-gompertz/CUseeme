<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>phase_cycle_v2_7_unified ‚Äî rear-cam ‚Ä¢ 9√ó14</title>

<!-- Neutral neumorphic base (your shared file) -->
<link rel="stylesheet" href="css/neumorphic_neutral.css">
<!-- Icons (tutorial set) -->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta1/css/all.css">

<style>
  :root{
    --bg:#e5e9f4;            /* neutral light gray (v2.5 tone) */
    --header-max:560px;
    --field-max-h:78vh;      /* size of the vertical field under header */
  }
  * { box-sizing:border-box; }
  html,body{
    margin:0; height:100%;
    background:var(--bg);
    font-family:system-ui, sans-serif;
    overflow:hidden;
  }

  /* ---------- Fixed, centered neumorphic header (6 buttons) ---------- */
  header{
    position:fixed; inset:0 0 auto 0; height:auto;
    display:flex; justify-content:center; align-items:center;
    padding:1rem 0;
    background:#e5e9f4;
    box-shadow:0 5px 10px rgba(0,0,0,0.05);
    z-index:1000;
  }
  .buttons{
    display:grid; gap:1rem;
    grid-template-columns:repeat(6, minmax(60px, 1fr));
    width:min(92vw, var(--header-max));
    margin:0 auto;
  }
  button.neumorphic{
    border:.5rem solid transparent; border-radius:1rem;
    background:none; color:hsl(0 0% 10%);
    display:grid; place-content:center; gap:.5rem;
    --shadow:-.5rem -.5rem 1rem hsl(0 0% 100%/.75),
             .5rem  .5rem 1rem hsl(0 0% 50%/.5);
    box-shadow:var(--shadow);
    outline:none; transition:transform .06s ease, color .12s ease, box-shadow .12s ease;
    touch-action:manipulation;
  }
  button.neumorphic > i{ font-size:20px; line-height:1; }
  button.neumorphic > span{ font-size:12px; line-height:1; }
  /* ‚Äúactive‚Äù style = pressed look from tutorial */
  button.neumorphic.active{
    box-shadow:var(--shadow),
               inset .5rem .5rem 1rem hsl(0 0% 50%/.5),
               inset -.5rem -.5rem 1rem hsl(0 0% 100%/.75);
    color:hsl(10 80% 50%);
  }
  @media (max-width:600px){
    .buttons{ gap:.5rem; width:95vw; }
    button.neumorphic > i{ font-size:16px; }
    button.neumorphic > span{ font-size:10px; }
  }

  /* ---------- Field container below header ---------- */
  main{
    position:fixed; inset:0; top:110px;   /* offset under header */
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .field{
    position:relative;
    height:var(--field-max-h);            /* drive size by height */
    aspect-ratio:9/14;                    /* vertical 9 √ó 14 */
    width:auto;
    background:#000;                      /* behind video */
    border-radius:22px;
    box-shadow:
      inset 1px 1px 2px rgba(255,255,255,0.8),
      inset -2px -3px 6px rgba(0,0,0,0.15),
      0 20px 40px rgba(0,0,0,0.15);
    overflow:hidden;
  }

  /* Single unified live video feed (no multi-panels in this file) */
  #live{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    transform:scaleX(-1);                 /* keep consistent ‚Äúmirror‚Äù feel */
    will-change:transform, filter;
    filter:brightness(1) contrast(1);
  }

  /* ---------- Status ticker (always visible) ---------- */
  .status{
    position:fixed; left:8px; bottom:6px; z-index:1200;
    font-family:monospace; font-size:12px; opacity:.75; color:#333;
    pointer-events:none;
    white-space:nowrap;
    text-shadow:0 1px 0 rgba(255,255,255,.6);
  }

  /* ---------- Tap-to-allow overlay (no fancy fade-in) ---------- */
  #avPrompt{
    position:fixed; inset:0; display:flex;
    justify-content:center; align-items:center;
    background:rgba(229,233,244,0.86);   /* soft neutral veil */
    z-index:1500;
  }
  #avPrompt .card{
    background:rgba(255,255,255,0.7);
    border:1px solid rgba(255,255,255,0.8);
    border-radius:16px;
    padding:14px 16px;
    box-shadow:0 12px 28px rgba(0,0,0,0.12);
    font-size:14px; color:#222;
  }
  #avPrompt .card b{ font-weight:600; }
  #avPrompt.hide{ display:none; } /* removed instantly after grant */

  /* Prevent accidental page scrolls on mobile */
  body, main, .field { touch-action:manipulation; }
</style>
</head>

<body>

<!-- Header: six controls (Room Tone / Voice / Phase / Counter / Step / Reverse Cam) -->
<header>
  <div class="buttons">
    <button class="neumorphic active" id="btnRoom">
      <i class="fa-light fa-waveform"></i><span>Room Tone</span>
    </button>
    <button class="neumorphic" id="btnVoice">
      <i class="fa-light fa-microphone"></i><span>Voice</span>
    </button>
    <button class="neumorphic active" id="btnPhase">
      <i class="fa-light fa-arrows-left-right"></i><span>Phase</span>
    </button>
    <button class="neumorphic" id="btnCounter">
      <i class="fa-light fa-shuffle"></i><span>Counter</span>
    </button>
    <button class="neumorphic" id="btnStep">
      <i class="fa-light fa-forward-step"></i><span>Step</span>
    </button>
    <button class="neumorphic" id="btnReverse">
      <i class="fa-light fa-camera-rotate"></i><span>Reverse Cam</span>
    </button>
  </div>
</header>

<main>
  <div class="field" id="field">
    <video id="live" muted playsinline autoplay></video>
  </div>
</main>

<div class="status" id="status">üéô Room tone active ‚Ä¢ In-phase ‚Ä¢ Rear cam</div>

<!-- Tap-to-allow overlay -->
<div id="avPrompt">
  <div class="card"><b>Tap to allow camera + mic</b></div>
</div>

<script>
/* =========================================================
  phase_cycle_v2_7_unified ‚Äî rear-cam default ‚Ä¢ 9√ó14
  - Single unified video field
  - Always-visible ticker
  - Tap-to-allow overlay (no fade-in), hides once granted
  - Controls: Room / Voice, Phase / Counter, Step, Reverse Cam
  - ‚ÄúMechanical‚Äù mic-driven modulation (no panel drift)
========================================================= */
let mediaStream = null;
let facing = 'environment';     // default rear camera
let audioCtx = null, analyser = null, dataTime = null, dataFreq = null;

const live = document.getElementById('live');
const statusEl = document.getElementById('status');
const promptEl = document.getElementById('avPrompt');

const BTN = {
  room:     document.getElementById('btnRoom'),
  voice:    document.getElementById('btnVoice'),
  phase:    document.getElementById('btnPhase'),
  counter:  document.getElementById('btnCounter'),
  step:     document.getElementById('btnStep'),
  reverse:  document.getElementById('btnReverse')
};

let mode = 'room';          // 'room' | 'voice'
let counterPhase = false;   // false=in-phase, true=counter
let cycleShift = 0;         // manual cycle phase accumulator

function setActive(btn, on){ btn.classList.toggle('active', !!on); }
function setStatus(){
  const camLabel = facing === 'user' ? 'Front cam' : 'Rear cam';
  statusEl.textContent =
    `${mode==='room'?'üéô Room tone active':'üé§ Voice mode'} ‚Ä¢ ` +
    `${counterPhase?'Counter':'In-phase'} ‚Ä¢ ${camLabel}`;
}

/* ---- Audio helpers ---- */
function getRMS(){
  if(!analyser) return 0;
  analyser.getByteTimeDomainData(dataTime);
  let sum=0;
  for(let i=0;i<dataTime.length;i++){
    const v=(dataTime[i]-128)/128;
    sum+=v*v;
  }
  return Math.sqrt(sum/dataTime.length); // ~0..0.5
}
function getLowEnergy(){
  if(!analyser) return 0;
  analyser.getByteFrequencyData(dataFreq);
  const nyquist = audioCtx.sampleRate/2;
  const limitHz = 300;
  const limitBin = Math.max(1, Math.floor(dataFreq.length * (limitHz/nyquist)));
  let sum=0;
  for(let i=0;i<limitBin;i++) sum+=dataFreq[i];
  return sum/(limitBin*255); // 0..1
}

/* ---- Start camera+mic ---- */
async function startAV() {
  if(mediaStream) return;
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: facing } },
      audio: true
    });
    live.srcObject = mediaStream;
    await live.play().catch(()=>{});

    // Audio analysis
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(mediaStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.85;
    dataTime = new Uint8Array(analyser.fftSize);
    dataFreq = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser);

    // Hide overlay promptly (no fancy fade-in/out)
    promptEl.classList.add('hide');
    setStatus();
  }catch(err){
    console.error(err);
    statusEl.textContent = '‚ö†Ô∏è Permission required (tap top message)';
  }
}

/* Require a tap (reliable on iOS/Safari) */
window.addEventListener('pointerdown', startAV, { once:true });
window.addEventListener('touchstart', startAV, { once:true });
promptEl.addEventListener('click', startAV);

/* ---- Reverse cam ---- */
async function switchCamera() {
  if(!mediaStream){
    await startAV(); // ensure permission
    return;
  }
  // stop old tracks
  mediaStream.getTracks().forEach(t=>t.stop());
  mediaStream = null;

  facing = (facing === 'user') ? 'environment' : 'user';
  await startAV();
}

/* ---- Animation: mechanical mic-driven modulation (no drift) ---- */
let t=0;
function animate(){
  requestAnimationFrame(animate);
  t += 0.015;

  let driver = 0.0;
  if(analyser){
    if(mode==='room'){
      const low = getLowEnergy();             // 0..1
      driver = 0.18 * low;                    // gentle, but visible
    }else{
      const rms = getRMS();                   // 0..~0.5
      driver = Math.min(0.35, rms * 1.4);     // punchier (asked for ‚Äúgo extreme‚Äù)
    }
  }

  // ‚ÄúPhase‚Äù vs ‚ÄúCounter‚Äù: steer a small oscillation sign
  const base = (counterPhase ? -1 : 1);
  const local = base * Math.sin(t*1.7 + cycleShift);   // ‚àí1..1
  const wobble = local * driver;

  // Mechanical adjustments: tiny translate + contrast/brightness
  const px = wobble * 10;                      // pixels left/right
  const br = 1 + wobble * 0.18;
  const ct = 1 + wobble * 0.15;

  live.style.transform = `translateX(${px}px) scaleX(-1)`;
  live.style.filter    = `brightness(${br}) contrast(${ct})`;
}
animate();

/* ---- Header controls ---- */
BTN.room.addEventListener('click', ()=>{
  mode='room';
  setActive(BTN.room, true); setActive(BTN.voice, false);
  setStatus();
});
BTN.voice.addEventListener('click', ()=>{
  mode='voice';
  setActive(BTN.voice, true); setActive(BTN.room, false);
  setStatus();
});
BTN.phase.addEventListener('click', ()=>{
  counterPhase=false;
  setActive(BTN.phase, true); setActive(BTN.counter, false);
  setStatus();
});
BTN.counter.addEventListener('click', ()=>{
  counterPhase=true;
  setActive(BTN.counter, true); setActive(BTN.phase, false);
  setStatus();
});
BTN.step.addEventListener('click', ()=>{
  cycleShift += Math.PI/9;  // small advance
  setStatus();
});
BTN.reverse.addEventListener('click', switchCamera);
</script>
</body>
</html>
