<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phase Cycle v2.5 ‚Äî Vertical Field (Room Tone + Voice)</title>

<link rel="stylesheet" href="css/neumorphic_neutral.css">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta1/css/all.css">

<style>
:root{
  --bg:#e5e9f4;
  --fieldW:min(80vw,800px);
  --overlap:10%;
}
html,body{
  margin:0; height:100%;
  background:var(--bg); overflow:hidden;
  font-family:system-ui,sans-serif;
}

/* ---------- Fixed neumorphic header ---------- */
header{
  position:fixed; top:0; left:0; width:100%;
  background:#e5e9f4;
  box-shadow:0 5px 10px rgba(0,0,0,0.05);
  z-index:1000;
  display:flex; justify-content:center; padding:1rem 0;
}
.buttons{
  display:grid; gap:1rem;
  grid-template-columns:repeat(6,minmax(60px,1fr));
  width:min(90vw,560px);
}
button.neumorphic{
  border:.5rem solid transparent; border-radius:1rem;
  color:hsl(0 0% 10%); background:none;
  display:grid; place-content:center; gap:.5rem;
  --shadow:-.5rem -.5rem 1rem hsl(0 0% 100%/.75),
           .5rem .5rem 1rem hsl(0 0% 50%/.5);
  box-shadow:var(--shadow);
  outline:none; transition:all .1s;
}
button.neumorphic>i{font-size:20px;}
button.neumorphic>span{font-size:12px;}
button.neumorphic:hover,button.neumorphic:focus-visible{color:hsl(10 80% 50%);scale:1.05;}
button.neumorphic:active,button.neumorphic.active{
  box-shadow:var(--shadow),
             inset .5rem .5rem 1rem hsl(0 0% 50%/.5),
             inset -.5rem -.5rem 1rem hsl(0 0% 100%/.75);
  color:hsl(10 80% 50%);
}
@media(max-width:600px){
  .buttons{grid-template-columns:repeat(6,1fr);gap:.5rem;width:95vw;}
  button.neumorphic>i{font-size:16px;}
  button.neumorphic>span{font-size:10px;}
}

/* ---------- Field (vertical 9:14) ---------- */
main{
  position:fixed; inset:0; top:85px;
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.field{
  position:relative;
  width:var(--fieldW);
  aspect-ratio:9/14;           /* flipped ratio */
  background:#000;
  box-shadow:0 10px 24px rgba(0,0,0,.15);
}
#canvas{
  position:absolute; inset:0; width:100%; height:100%;
  display:block; touch-action:none;
}

/* ---------- Status ---------- */
.status{
  position:fixed; left:8px; bottom:6px; z-index:1200;
  font-family:monospace; font-size:12px; opacity:.75; color:#333;
  pointer-events:none;
}
</style>
</head>

<body>

<header>
  <div class="buttons">
    <button class="neumorphic active" id="btnRoom"><i class="fa-light fa-waveform"></i><span>Room Tone</span></button>
    <button class="neumorphic" id="btnVoice"><i class="fa-light fa-microphone"></i><span>Voice</span></button>
    <button class="neumorphic" id="btnPhase"><i class="fa-light fa-arrows-left-right"></i><span>In-Phase</span></button>
    <button class="neumorphic" id="btnCounter"><i class="fa-light fa-shuffle"></i><span>Counter</span></button>
    <button class="neumorphic" id="btnStep"><i class="fa-light fa-forward-step"></i><span>Cycle Step</span></button>
    <button class="neumorphic" id="btnAuto"><i class="fa-light fa-arrows-rotate"></i><span>Cycle Auto</span></button>
  </div>
</header>

<main>
  <div class="field">
    <canvas id="canvas"></canvas>
  </div>
</main>

<div class="status" id="status">üéô Room tone active ‚Ä¢ In-phase ‚Ä¢ Cycle idle</div>

<script>
const N_SLICES=6,OVERLAP_FRAC=0.10,PHASE_INCR_IN=Math.PI/10,PHASE_INCR_COUNTER=Math.PI/4;
let mode='room',counterPhase=false,cycleShift=0,autoTimer=null;
const statusEl=document.getElementById('status');
const BTN={
  room:btnRoom,voice:btnVoice,phase:btnPhase,counter:btnCounter,step:btnStep,auto:btnAuto
};
const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d',{alpha:false});
let off=document.createElement('canvas'),offCtx=off.getContext('2d');
let stream=null;const video=document.createElement('video');video.muted=true;video.playsInline=true;video.autoplay=true;
let audioCtx=null,analyser=null,dataTime=null,dataFreq=null;

function fitCanvas(){
  const r=canvas.getBoundingClientRect(),dpr=Math.max(1,Math.floor(window.devicePixelRatio||1));
  canvas.width=Math.floor(r.width*dpr);canvas.height=Math.floor(r.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  off.width=Math.floor(r.width);off.height=Math.floor(r.height);
}
window.addEventListener('resize',fitCanvas);fitCanvas();

async function startAV(){
  if(stream)return;
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:true});
    video.srcObject=stream;video.play().catch(()=>{});
    audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    const src=audioCtx.createMediaStreamSource(stream);
    analyser=audioCtx.createAnalyser();analyser.fftSize=2048;analyser.smoothingTimeConstant=0.8;
    dataTime=new Uint8Array(analyser.fftSize);dataFreq=new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser);
    setStatus();
  }catch(e){statusEl.textContent='‚ö†Ô∏è Tap to allow camera/mic';console.error(e);}
}
window.addEventListener('DOMContentLoaded',startAV);

function getRMS(){
  if(!analyser)return 0;analyser.getByteTimeDomainData(dataTime);
  let s=0;for(let i=0;i<dataTime.length;i++){const v=(dataTime[i]-128)/128;s+=v*v;}
  return Math.sqrt(s/dataTime.length);
}
function getLowEnergy(){
  if(!analyser)return 0;analyser.getByteFrequencyData(dataFreq);
  const nyq=audioCtx.sampleRate/2,limitHz=300,limitBin=Math.max(1,Math.floor(dataFreq.length*(limitHz/nyq)));
  let s=0;for(let i=0;i<limitBin;i++)s+=dataFreq[i];
  return s/(limitBin*255);
}

let t=0;
function draw(){
  requestAnimationFrame(draw);t+=0.016;
  const vw=video.videoWidth,vh=video.videoHeight;if(!vw||!vh){ctx.clearRect(0,0,canvas.width,canvas.height);return;}
  const W=off.width,H=off.height,r=Math.max(W/vw,H/vh),nw=vw*r,nh=vh*r,ox=(W-nw)/2,oy=(H-nh)/2;
  offCtx.clearRect(0,0,W,H);offCtx.drawImage(video,ox,oy,nw,nh);
  let driver=0;if(analyser){driver=mode==='room'?getLowEnergy()*1.4:getRMS()*3.0;driver=Math.min(1.25,driver);}
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const sliceW=W/N_SLICES,stride=counterPhase?PHASE_INCR_COUNTER:PHASE_INCR_IN;
  for(let i=0;i<N_SLICES;i++){
    const p=(t*(mode==='room'?1.2:2.4))+i*stride+cycleShift,px=Math.sin(p)*driver*14,
          br=1+Math.sin(p+Math.PI/2)*driver*0.25,ct=1+Math.cos(p)*driver*0.22;
    const overlap=sliceW*OVERLAP_FRAC,sx=Math.max(0,i*sliceW-overlap/2),sw=Math.min(W-sx,sliceW+overlap);
    ctx.save();ctx.beginPath();ctx.rect(sx,0,sw,H);ctx.clip();
    ctx.filter=`brightness(${br}) contrast(${ct})`;
    ctx.drawImage(off,ox+px,oy,nw,nh);ctx.filter='none';ctx.restore();
  }
}
draw();

function setActive(b,on){b.classList.toggle('active',!!on);}
function setStatus(){
  statusEl.textContent=`${mode==='room'?'üéô Room tone active':'üé§ Voice mode'} ‚Ä¢ ${counterPhase?'Counter':'In-phase'} ‚Ä¢ ${autoTimer?'Cycle auto':'Cycle idle'}`;
}
BTN.room.onclick=()=>{mode='room';setActive(BTN.room,1);setActive(BTN.voice,0);setStatus();};
BTN.voice.onclick=()=>{mode='voice';setActive(BTN.voice,1);setActive(BTN.room,0);setStatus();};
BTN.phase.onclick=()=>{counterPhase=0;setActive(BTN.phase,1);setActive(BTN.counter,0);setStatus();};
BTN.counter.onclick=()=>{counterPhase=1;setActive(BTN.counter,1);setActive(BTN.phase,0);setStatus();};
BTN.step.onclick=()=>{cycleShift+=Math.PI/8;setStatus();};
BTN.auto.onclick=()=>{if(autoTimer){clearInterval(autoTimer);autoTimer=null;setActive(BTN.auto,0);}
 else{autoTimer=setInterval(()=>{cycleShift+=Math.PI/10;},700);setActive(BTN.auto,1);}setStatus();};
</script>
</body>
</html>
