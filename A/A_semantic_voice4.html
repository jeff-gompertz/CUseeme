<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CUSeeMe â€” Version B Core (Clean Final Build)</title>

<style>
  :root{
    --bg:#0b0c0e;
    --ink:#f5f5f7;
    --accent:#ff4433;
    --accent2:#3ea6ff;
    --note:#8b8f97;
  }

  html,body{
    margin:0;padding:0;height:100%;
    background:var(--bg);
    color:var(--ink);
    font-family:"VT323", ui-monospace, Menlo, Consolas, monospace;
    overflow:hidden;
  }

  /* Prompt Bar */
  #promptWrap{
    position:fixed;inset:0;
    display:grid;place-items:center;
    pointer-events:none;z-index:10;
  }
  #promptBox{
    backdrop-filter:blur(22px) saturate(1.2);
    background:rgba(15,15,18,0.82);
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);

    box-shadow:0 18px 48px rgba(0,0,0,0.65),
                0 0 0 1px rgba(255,255,255,0.08);

    display:flex;align-items:center;gap:.55rem;
    padding:.7rem 1.2rem;
    font-size:2rem;
    pointer-events:auto;
  }

  #caret{
    width:.25ch;height:1.3em;background:var(--ink);
    animation:blink 1s step-end infinite;
  }
  @keyframes blink{50%{opacity:0}}

  #input{
    border:0;outline:0;
    background:transparent;
    color:var(--ink);
    font:inherit;width:18ch;
  }
  #input::placeholder{color:rgba(255,255,255,0.35)}

  .pill-btn{
    border:0;
    cursor:pointer;
    font-size:1.55rem;
    padding:.32rem .62rem;
    border-radius:999px;
    background:rgba(255,255,255,0.05);
    color:var(--ink);
    display:flex;align-items:center;justify-content:center;
    transition:0.15s ease;
  }
  .pill-btn:hover{
    background:rgba(255,255,255,0.12);
    transform:translateY(-1px);
  }
  .pill-btn.on{
    background:rgba(255,68,51,0.25);
    box-shadow:0 0 16px rgba(255,68,51,0.45);
  }

  /* Ticker */
  #ticker{
    position:fixed;
    left:14px;bottom:14px;
    width:min(42vw,560px);
    max-height:60vh;
    display:flex;flex-direction:column-reverse;
    font-size:1.18rem;line-height:1.28rem;
    overflow:hidden;
    z-index:1;
  }
  .tline{
    margin-bottom:4px;
    opacity:.95;
    white-space:pre-wrap;
    animation:fadeIn .3s ease-out;
    transition:opacity 60s linear;
  }
  .t-user{color:var(--accent2)}
  .t-sys{color:var(--accent)}
  .t-note{color:var(--note)}

  @keyframes fadeIn{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:.95;transform:translateY(0)}
  }
</style>
</head>

<body>

<!-- Prompt -->
<div id="promptWrap">
  <div id="promptBox">
    <button id="btnMic" class="pill-btn" title="Start/stop mic">ðŸŽ™</button>
    <div id="caret"></div>
    <input id="input" type="text" placeholder="type or speakâ€¦" autocomplete="off" spellcheck="false" />
    <button id="btnVoice" class="pill-btn" title="Toggle spoken replies">ðŸ”Š</button>
  </div>
</div>

<!-- Ticker -->
<div id="ticker" aria-live="polite"></div>

<script>
/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
const ticker = $('#ticker');

function addLine(text, cls="t-sys"){
  const el = document.createElement('div');
  el.className = "tline " + cls;
  el.textContent = text;
  ticker.prepend(el);

  while(ticker.children.length > 120)
    ticker.removeChild(ticker.lastChild);

  setTimeout(()=> el.style.opacity = 0.18, 60000);
}

/* ========= Speech Synthesis (patched clean) ========= */
let voiceOn = true;
let voicesReady = false;

function waitForVoices(){
  return new Promise(res=>{
    if(voicesReady && speechSynthesis.getVoices().length) return res();
    const id=setInterval(()=>{
      if(speechSynthesis.getVoices().length){
        clearInterval(id);
        voicesReady = true;
        res();
      }
    },120);
  });
}

/* Completely safe voice selector */
function pickSafeVoice(list){
  if(!list?.length) return null;
  const blacklist=/melody|opera|sing|vocal/i;
  const safe=list.filter(v=>!blacklist.test(v.name));
  const prefs=[/neutral/i,/news/i,/story/i,/narrator/i,/google us english/i,/samantha/i,/ava/i,/aria/i];
  for(const p of prefs){
    const f=safe.find(v=>p.test(v.name));
    if(f) return f;
  }
  return safe[0]||list[0]||null;
}

async function speak(text){
  if(!voiceOn) return;
  if(!("speechSynthesis" in window)) return;

  await waitForVoices();
  const all=speechSynthesis.getVoices();
  const u=new SpeechSynthesisUtterance(text);
  u.lang="en-US"; u.rate=1.0; u.pitch=1.0; u.volume=0.9;
  u.voice=pickSafeVoice(all);
  speechSynthesis.speak(u);
}

/* Required for iOS */
function unlockSpeech(){
  try{
    const u=new SpeechSynthesisUtterance(" ");
    speechSynthesis.speak(u); speechSynthesis.cancel();
  }catch{}
}
window.addEventListener("touchstart", unlockSpeech, {once:true});
window.addEventListener("click", unlockSpeech, {once:true});

/* ========= Reply Logic (simple placeholder) ========= */
function buildReply(text){
  const t=text.toLowerCase();
  if(t==="hello"||t==="hi"||t.startsWith("hey"))
    return "Hello. I'm listening.";
  if(t.includes("you there"))
    return "Yes, I'm here.";
  return "You said: " + text;
}

/* ========= Text submit ========= */
const input=$('#input');
input.addEventListener('keydown',e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const v=input.value.trim();
    input.value="";
    handleSubmit(v);
  }
});

function handleSubmit(raw){
  const text=(raw||"").trim();
  if(!text) return;
  addLine("> " + text, "t-user");
  const reply=buildReply(text);
  addLine("< " + reply, "t-sys");
  speak(reply);
}

/* ========= Voice input ========= */
const btnMic=$('#btnMic');
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;

let rec=null, listening=false, interim="";

if(!SR){
  btnMic.disabled=true;
  addLine("âš  voice recognition unavailable","t-note");
}else{
  rec=new SR();
  rec.lang="en-US";
  rec.continuous=true;
  rec.interimResults=true;

  rec.onstart=()=>{
    listening=true;
    addLine("ðŸŽ¤ mic on â€” listeningâ€¦","t-note");
    btnMic.classList.add("on");
  };

  rec.onend=()=>{
    listening=false;
    btnMic.classList.remove("on");
    addLine("â¹ mic off","t-note");
  };

  rec.onerror=e=> addLine("mic error: "+e.error,"t-note");

  rec.onresult=evt=>{
    let final="";
    interim="";
    for(let i=evt.resultIndex;i<evt.results.length;i++){
      const t=evt.results[i][0].transcript;
      if(evt.results[i].isFinal) final+=t+" ";
      else interim+=t;
    }
    if(interim) input.value=interim;
    if(final.trim()){
      input.value="";
      handleSubmit(final.trim());
    }
  };

  btnMic.addEventListener("click",()=>{
    try{
      if(!listening) rec.start();
      else rec.stop();
    }catch(err){
      addLine("mic toggle error: "+err.message,"t-note");
    }
  });
}

/* ========= Voice toggle ========= */
$('#btnVoice').addEventListener("click",()=>{
  voiceOn=!voiceOn;
  const b=$('#btnVoice');
  b.classList.toggle("on",voiceOn);
  b.textContent=voiceOn?"ðŸ”Š":"ðŸ”‡";
  addLine("voice replies "+(voiceOn?"enabled":"muted"),"t-note");
});

/* ========= Startup ========= */
addLine("session ready â€” type or press ðŸŽ™ and speak","t-note");

</script>
</body>
</html>
