<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CUSeeMe â€” Version A Core (Voice + Text + Ticker)</title>

<style>
  :root{
    --bg: #0b0c0e;
    --ink: #f5f5f7;
    --accent: #ff4433;
    --accent2: #3ea6ff;
    --note: #8b8f97;
  }

  html,body{
    margin:0;padding:0;height:100%;
    background:var(--bg);
    color:var(--ink);
    font-family:"VT323", ui-monospace, monospace;
    -webkit-font-smoothing:antialiased;
    overflow:hidden;
  }

  /* Center prompt */
  #promptWrap{
    position:fixed;inset:0;
    display:grid;place-items:center;
    pointer-events:none;z-index:2;
  }
  #promptBox{
    pointer-events:auto;
    display:flex;align-items:center;gap:.5rem;
    padding:.6rem 1rem;
    font-size:2rem;
    background:rgba(15,15,18,0.82);
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    box-shadow:0 14px 38px rgba(0,0,0,0.75);
  }
  #caret{
    width:.25ch;height:1.3em;
    background:var(--ink);
    animation:blink 1s step-end infinite;
  }
  @keyframes blink{50%{opacity:0}}

  #input{
    border:0;outline:0;
    background:transparent;
    color:var(--ink);
    font:inherit;
    width:18ch;
  }
  #input::placeholder{
    color:rgba(255,255,255,0.35);
  }

  /* Buttons */
  .pill-btn{
    cursor:pointer;border:0;outline:0;
    padding:.3rem .6rem;
    font-size:1.5rem;
    border-radius:999px;
    background:rgba(255,255,255,0.05);
    color:var(--ink);
  }
  .pill-btn.on{
    background:rgba(255,68,51,0.25);
    box-shadow:0 0 12px rgba(255,68,51,0.3);
  }

  /* Ticker */
  #ticker{
    position:fixed;left:12px;bottom:12px;
    width:min(42vw,560px);
    max-height:60vh;
    display:flex;flex-direction:column-reverse;
    overflow:hidden;z-index:1;
    font-size:1.15rem;line-height:1.25rem;
  }
  .tline{
    margin:0 0 3px 0;
    opacity:.95;white-space:pre-wrap;
    animation:fadeIn .3s ease-out forwards;
    transition:opacity 60s linear;
  }
  .t-user{color:var(--accent2);}
  .t-sys{color:var(--accent);}
  .t-note{color:var(--note);}
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:.95;transform:translateY(0)}
  }
</style>
</head>
<body>

<!-- Prompt -->
<div id="promptWrap">
  <div id="promptBox">
    <button id="btnMic"   class="pill-btn" title="mic on/off">ðŸŽ™</button>
    <div id="caret"></div>
    <input id="input" type="text" placeholder="type or speakâ€¦" autocomplete="off" />
    <button id="btnVoice" class="pill-btn on" title="voice reply">ðŸ”Š</button>
  </div>
</div>

<!-- Ticker -->
<div id="ticker"></div>

<script>
/* ---------- Helpers ---------- */
const $ = sel => document.querySelector(sel);
const ticker = $('#ticker');

function addLine(txt, cls="t-sys"){
  const el = document.createElement('div');
  el.className = "tline " + cls;
  el.textContent = txt;
  ticker.prepend(el);
  if(ticker.children.length > 120)
    ticker.removeChild(ticker.lastChild);
  setTimeout(()=> el.style.opacity = 0.18, 60000);
}

/* ---------- Voice synthesis (clean, no singing) ---------- */
let voiceOn = true;
let voicesReady = false;

function waitForVoices(){
  return new Promise(res=>{
    if(voicesReady && speechSynthesis.getVoices().length) return res();
    const id = setInterval(()=>{
      if(speechSynthesis.getVoices().length){
        clearInterval(id);
        voicesReady = true;
        res();
      }
    },120);
  });
}

function pickSafeVoice(list){
  const blacklist = /(melody|opera|sing|vocal)/i;
  const safe = list.filter(v => !blacklist.test(v.name));
  return safe[0] || list[0] || null;
}

async function speak(text){
  if(!voiceOn) return;
  if(!("speechSynthesis" in window)) return;

  await waitForVoices();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = 1.0;
  u.pitch = 1.0;

  u.voice = pickSafeVoice(speechSynthesis.getVoices());
  speechSynthesis.speak(u);
}

/* ---------- iOS unlock ---------- */
function unlockSpeechOnce(){
  try{
    const u = new SpeechSynthesisUtterance(" ");
    speechSynthesis.speak(u);
    speechSynthesis.cancel();
  }catch(e){}
  window.removeEventListener("touchstart",unlockSpeechOnce);
  window.removeEventListener("click",unlockSpeechOnce);
}
window.addEventListener("touchstart",unlockSpeechOnce,{once:true});
window.addEventListener("click",unlockSpeechOnce,{once:true});

/* ---------- Basic reply logic ---------- */
function buildReply(t){
  const x = t.toLowerCase().trim();
  if(x.startsWith("hi") || x==="hello")
    return "Hello. I'm listening.";
  return "You said: " + t;
}

/* ---------- Submit (text or voice) ---------- */
function handleSubmit(raw){
  const t = (raw||"").trim();
  if(!t) return;

  addLine("> " + t, "t-user");

  const reply = buildReply(t);
  addLine("< " + reply, "t-sys");
  speak(reply);
}

/* ---------- Text input ---------- */
const input = $("#input");
input.addEventListener("keydown", e=>{
  if(e.key === "Enter"){
    e.preventDefault();
    const v = input.value.trim();
    input.value = "";
    handleSubmit(v);
  }
});

/* ---------- Voice input ---------- */
const btnMic = $("#btnMic");
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

let rec = null;
let listening = false;
let interimText = "";

if(!SR){
  btnMic.disabled = true;
  addLine("âš  voice recognition unavailable", "t-note");
}
else {
  rec = new SR();
  rec.lang = "en-US";
  rec.continuous = true;
  rec.interimResults = true;

  rec.onstart = ()=>{
    listening = true;
    addLine("ðŸŽ¤ mic on â€” listeningâ€¦","t-note");
  };
  rec.onend = ()=>{
    listening = false;
    addLine("â¹ mic off","t-note");
  };
  rec.onerror = e=>{
    addLine("mic error: "+e.error,"t-note");
  };

  rec.onresult = evt=>{
    let finalChunk = "";
    interimText = "";

    for(let i=evt.resultIndex;i<evt.results.length;i++){
      const txt = evt.results[i][0].transcript;
      if(evt.results[i].isFinal) finalChunk += txt + " ";
      else interimText += txt;
    }

    if(interimText) input.value = interimText;

    if(finalChunk.trim()){
      input.value = "";
      handleSubmit(finalChunk.trim());
    }
  };

  btnMic.addEventListener("click", ()=>{
    try{
      if(!listening) rec.start();
      else rec.stop();
    }catch(err){
      addLine("mic toggle error: "+err.message,"t-note");
    }
  });
}

/* ---------- Voice toggle ---------- */
const btnVoice = $("#btnVoice");
btnVoice.addEventListener("click",()=>{
  voiceOn = !voiceOn;
  btnVoice.classList.toggle("on", voiceOn);
  btnVoice.textContent = voiceOn ? "ðŸ”Š" : "ðŸ”‡";
  addLine("voice replies "+(voiceOn?"enabled":"muted"),"t-note");
});

/* ---------- Startup ---------- */
addLine("session ready â€” type or press ðŸŽ™ and speak","t-note");

</script>
</body>
</html>
