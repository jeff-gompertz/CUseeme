<script>
/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
const ticker = $('#ticker');

function addLine(text, cls="t-sys"){
  const el = document.createElement('div');
  el.className = 'tline ' + cls;
  el.textContent = text;
  ticker.prepend(el);
  const MAX = 120;
  while(ticker.children.length > MAX) ticker.removeChild(ticker.lastChild);
  setTimeout(()=>{ el.style.opacity = 0.18; }, 60000);
}

/* =======================================================================
   SPEECH SYNTHESIS â€” CLEAN / NON-SINGING
======================================================================= */
let voiceOn = true;
let voicesReady = false;

function waitForVoices(){
  return new Promise(res=>{
    if(voicesReady && speechSynthesis.getVoices().length) return res();
    const id = setInterval(()=>{
      if(speechSynthesis.getVoices().length){
        clearInterval(id);
        voicesReady = true;
        res();
      }
    }, 120);
  });
}

/* Non-singing voice filter */
function pickSafeVoice(list){
  if (!list || !list.length) return null;

  const blacklist = /(melody|opera|sing|vocal)/i;
  const safe = list.filter(v => !blacklist.test(v.name));

  const preferred = [
    /neutral/i, /news/i, /story/i, /narrator/i,
    /google us english/i, /samantha/i, /ava/i, /aria/i
  ];

  for (const p of preferred){
    const v = safe.find(v => p.test(v.name));
    if (v) return v;
  }

  return safe[0] || list[0] || null;
}

async function speak(text){
  if (!voiceOn) return;
  if (!('speechSynthesis' in window)) return;

  await waitForVoices();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = 1.0;
  u.pitch = 1.0;
  u.volume = 0.9;

  u.voice = pickSafeVoice(speechSynthesis.getVoices());

  speechSynthesis.speak(u);
}

/* =======================================================================
   iOS unlock
======================================================================= */
function unlockSpeechOnce(){
  try{
    const u = new SpeechSynthesisUtterance(' ');
    speechSynthesis.speak(u);
    speechSynthesis.cancel();
  }catch(e){}
  window.removeEventListener('touchstart', unlockSpeechOnce);
  window.removeEventListener('click', unlockSpeechOnce);
}

window.addEventListener('touchstart', unlockSpeechOnce, {once:true});
window.addEventListener('click', unlockSpeechOnce, {once:true});

/* =======================================================================
   CORE REPLY LOGIC (placeholder)
======================================================================= */
function buildReply(text){
  const t = text.toLowerCase().trim();
  if (!t) return "";

  if (t === "hello" || t === "hi" || t.startsWith("hi "))
    return "Hello. I'm listening.";

  return "You said: " + text;
}

/* =======================================================================
   SUBMIT HANDLER
======================================================================= */
function handleSubmit(raw){
  const text = (raw || '').trim();
  if (!text) return;

  addLine('> ' + text, 't-user');

  const reply = buildReply(text);
  if (reply){
    addLine('< ' + reply, 't-sys');
    speak(reply);
  }
}

/* =======================================================================
   TEXT INPUT
======================================================================= */
const input = $('#input');
input.addEventListener('keydown', e=>{
  if (e.key === 'Enter'){
    e.preventDefault();
    const val = input.value.trim();
    input.value = '';
    handleSubmit(val);
  }
});

/* =======================================================================
   VOICE INPUT (SpeechRecognition)
======================================================================= */
const btnMic = $('#btnMic');
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

let rec = null;
let listening = false;
let interimText = '';

if (!SR){
  btnMic.disabled = true;
  addLine('âš  voice recognition unavailable', 't-note');
} else {
  rec = new SR();
  rec.lang = 'en-US';
  rec.continuous = true;
  rec.interimResults = true;

  rec.onstart = ()=>{
    listening = true;
    addLine('ðŸŽ¤ mic on â€” listeningâ€¦', 't-note');
  };
  rec.onend = ()=>{
    listening = false;
    addLine('â¹ mic off', 't-note');
  };
  rec.onerror = e=>{
    addLine('mic error: ' + e.error, 't-note');
  };

  rec.onresult = evt=>{
    let finalChunk = '';
    interimText = '';

    for (let i = evt.resultIndex; i < evt.results.length; i++){
      const txt = evt.results[i][0].transcript;
      if (evt.results[i].isFinal) finalChunk += txt + ' ';
      else interimText += txt;
    }

    if (interimText) input.value = interimText;

    if (finalChunk.trim()){
      input.value = '';
      handleSubmit(finalChunk.trim());
    }
  };

  btnMic.addEventListener('click', ()=>{
    try{
      if (!listening) rec.start();
      else rec.stop();
    }catch(err){
      addLine('mic toggle error: ' + err.message, 't-note');
    }
  });
}

/* =======================================================================
   VOICE TOGGLE
======================================================================= */
const btnVoice = $('#btnVoice');
btnVoice.addEventListener('click', ()=>{
  voiceOn = !voiceOn;
  btnVoice.classList.toggle('on', voiceOn);
  btnVoice.textContent = voiceOn ? 'ðŸ”Š' : 'ðŸ”‡';
  addLine('voice replies ' + (voiceOn ? 'enabled' : 'muted'), 't-note');
});

/* =======================================================================
   STARTUP
======================================================================= */
addLine('session ready â€” type or press ðŸŽ™ and speak', 't-note');
</script>
