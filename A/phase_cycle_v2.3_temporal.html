<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phase Cycle v2.3 ‚Äî Temporal Offset (Room Tone + Voice)</title>

<!-- Neutral neumorphic base -->
<link rel="stylesheet" href="css/neumorphic_neutral.css">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta1/css/all.css">

<style>
:root{
  --bg:#e5e9f4;
  --fieldW:min(92vw,1100px);
  --overlap:6%;
}
html,body{
  margin:0; height:100%;
  background:var(--bg);
  overflow:hidden;
  font-family:system-ui,sans-serif;
}

/* ---------- Fixed neumorphic header ---------- */
header{
  position:fixed; top:0; left:0; width:100%;
  background:#e5e9f4;
  box-shadow:0 5px 10px rgba(0,0,0,0.05);
  z-index:1000;
  display:flex; justify-content:center; padding:1rem 0;
}
.buttons{
  display:grid; gap:1rem;
  grid-template-columns:repeat(6,minmax(60px,1fr));
  width:min(90vw,560px);
}
button.neumorphic{
  border:.5rem solid transparent; border-radius:1rem;
  color:hsl(0 0% 10%); background:none;
  display:grid; place-content:center; gap:.5rem;
  --shadow:-.5rem -.5rem 1rem hsl(0 0% 100%/.75),
           .5rem .5rem 1rem hsl(0 0% 50%/.5);
  box-shadow:var(--shadow);
  outline:none; transition:all .1s;
}
button.neumorphic > i{ font-size:20px; }
button.neumorphic > span{ font-size:12px; }
button.neumorphic:hover,button.neumorphic:focus-visible{ color:hsl(10 80% 50%); scale:1.05; }
button.neumorphic:active,button.neumorphic.active{
  box-shadow:var(--shadow),
             inset .5rem .5rem 1rem hsl(0 0% 50%/.5),
             inset -.5rem -.5rem 1rem hsl(0 0% 100%/.75);
  color:hsl(10 80% 50%);
}
@media(max-width:600px){
  .buttons{ grid-template-columns:repeat(6,1fr); gap:.5rem; width:95vw; }
  button.neumorphic > i{ font-size:16px; }
  button.neumorphic > span{ font-size:10px; }
}

/* ---------- Field ---------- */
main{
  position:fixed; inset:0; top:110px;
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
}
.field{
  position:relative;
  width:var(--fieldW);
  aspect-ratio:14/9;
  background:#000;
}
.panel{
  position:absolute; top:0; bottom:0;
  width:calc(100%/6 + var(--overlap));
  left:calc((var(--i)*(100%/6)) - (var(--overlap)*.5));
  overflow:hidden;
  opacity:1;
  border-radius:0;
  box-shadow:0 10px 20px rgba(0,0,0,0.05), inset 0 1px 2px rgba(255,255,255,0.4);
  transition:filter .15s ease;
}
.panel video{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  transform:scaleX(-1);
  filter:brightness(1) contrast(1);
}
.status{
  position:fixed; left:8px; bottom:6px;
  font-family:monospace; font-size:12px; opacity:.7; color:#333;
  pointer-events:none; z-index:2000;
}
</style>
</head>

<body>

<header>
  <div class="buttons">
    <button class="neumorphic active" id="btnRoom"><i class="fa-light fa-waveform"></i><span>Room Tone</span></button>
    <button class="neumorphic" id="btnVoice"><i class="fa-light fa-microphone"></i><span>Voice</span></button>
    <button class="neumorphic" id="btnPhase"><i class="fa-light fa-arrows-left-right"></i><span>In-Phase</span></button>
    <button class="neumorphic" id="btnCounter"><i class="fa-light fa-shuffle"></i><span>Counter</span></button>
    <button class="neumorphic" id="btnStep"><i class="fa-light fa-forward-step"></i><span>Cycle Step</span></button>
    <button class="neumorphic" id="btnAuto"><i class="fa-light fa-arrows-rotate"></i><span>Cycle Auto</span></button>
  </div>
</header>

<main>
  <div class="field" id="field">
    <div class="panel" style="--i:0;"><video class="v" muted playsinline autoplay></video></div>
    <div class="panel" style="--i:1;"><video class="v" muted playsinline autoplay></video></div>
    <div class="panel" style="--i:2;"><video class="v" muted playsinline autoplay></video></div>
    <div class="panel" style="--i:3;"><video class="v" muted playsinline autoplay></video></div>
    <div class="panel" style="--i:4;"><video class="v" muted playsinline autoplay></video></div>
    <div class="panel" style="--i:5;"><video class="v" muted playsinline autoplay></video></div>
  </div>
</main>

<div class="status" id="status">üéô Room tone active ‚Ä¢ In-phase ‚Ä¢ Cycle idle</div>

<script>
let mediaStream=null,audioCtx=null,analyser=null,dataTime=null,dataFreq=null;
const videos=[...document.querySelectorAll('.v')];
const statusEl=document.getElementById('status');
const BTN={
  room:btnRoom,voice:btnVoice,phase:btnPhase,counter:btnCounter,step:btnStep,auto:btnAuto
};
let mode='room',counterPhase=false,cycleShift=0,autoTimer=null;

/* ---------- SAFE CAMERA + MIC BOOT ---------- */
async function startAV(){
  if(mediaStream) return;
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}},
      audio:true
    });
    videos.forEach(v=>{v.srcObject=mediaStream;v.play().catch(()=>{});});

    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const src=audioCtx.createMediaStreamSource(mediaStream);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=2048;
    analyser.smoothingTimeConstant=0.85;
    dataTime=new Uint8Array(analyser.fftSize);
    dataFreq=new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser);
    setStatus();
  }catch(e){
    statusEl.textContent='‚ö†Ô∏è tap to allow camera & mic‚Ä¶';
    console.error(e);
  }
}
window.addEventListener('pointerdown',startAV,{once:true});
window.addEventListener('touchstart',startAV,{once:true});

/* ---------- AUDIO METRICS ---------- */
function getRMS(){
  if(!analyser) return 0;
  analyser.getByteTimeDomainData(dataTime);
  let sum=0;
  for(let i=0;i<dataTime.length;i++){const v=(dataTime[i]-128)/128;sum+=v*v;}
  return Math.sqrt(sum/dataTime.length);
}
function getLowEnergy(){
  if(!analyser) return 0;
  analyser.getByteFrequencyData(dataFreq);
  const nyquist=audioCtx.sampleRate/2,limitHz=300;
  const limitBin=Math.max(1,Math.floor(dataFreq.length*(limitHz/nyquist)));
  let sum=0;for(let i=0;i<limitBin;i++) sum+=dataFreq[i];
  return sum/(limitBin*255);
}

/* ---------- ANIMATION ---------- */
let t=0;
function animate(){
  requestAnimationFrame(animate);
  t+=0.015;
  let driver=0;
  if(analyser){
    if(mode==='room'){driver=0.12*getLowEnergy();}
    else{driver=Math.min(0.25,getRMS()*0.9);}
  }
  const baseSpeed=(mode==='room'?0.6:1.8);
  const phaseStride=(counterPhase?Math.PI/4:Math.PI/8);
  document.querySelectorAll('.panel').forEach((p,i)=>{
    const localPhase=t*baseSpeed+i*phaseStride+cycleShift;
    const wobble=Math.sin(localPhase)*driver;
    const v=p.querySelector('video');
    const px=wobble*6;
    const br=1+wobble*0.12;
    const ct=1+wobble*0.10;
    v.style.transform=`translateX(${px}px) scaleX(-1)`;
    v.style.filter=`brightness(${br}) contrast(${ct})`;
  });
}
animate();

/* ---------- UI CONTROLS ---------- */
function setActive(btn,on){btn.classList.toggle('active',!!on);}
function setStatus(){
  statusEl.textContent=
    `${mode==='room'?'üéô Room tone active':'üé§ Voice mode'} ‚Ä¢ `+
    `${counterPhase?'Counter':'In-phase'} ‚Ä¢ `+
    `${autoTimer?'Cycle auto':'Cycle idle'}`;
}
BTN.room.onclick=()=>{mode='room';setActive(BTN.room,true);setActive(BTN.voice,false);setStatus();};
BTN.voice.onclick=()=>{mode='voice';setActive(BTN.voice,true);setActive(BTN.room,false);setStatus();};
BTN.phase.onclick=()=>{counterPhase=false;setActive(BTN.phase,true);setActive(BTN.counter,false);setStatus();};
BTN.counter.onclick=()=>{counterPhase=true;setActive(BTN.counter,true);setActive(BTN.phase,false);setStatus();};
BTN.step.onclick=()=>{cycleShift+=Math.PI/9;setStatus();};
BTN.auto.onclick=()=>{
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;setActive(BTN.auto,false);}
  else{autoTimer=setInterval(()=>{cycleShift+=Math.PI/12;},900);setActive(BTN.auto,true);}
  setStatus();
};
</script>
</body>
</html>
