<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>CUSeeMe v2 ‚Äî BBC2 (patched)</title>
<style>
/* === Base / layout === */
html,body{margin:0;padding:0;height:100%;background:#000;font-family:"VT323",monospace;color:#0f0;overflow:hidden;}
#camera{position:fixed;inset:0;object-fit:cover;transform:scaleX(-1);z-index:0;filter:brightness(1.05) contrast(1.1);}

/* === Prevent iOS tap highlight & accidental selection === */
html, body, a, button, input, #hudToggle, #hudToggle_nav, #miniFeed, .repo-nav {
  -webkit-tap-highlight-color: transparent;   /* iOS tap highlight */
  -webkit-touch-callout: none;                 /* disable callout (copy/paste) */
  -webkit-user-select: none;                   /* prevent accidental text selection */
  user-select: none;
  touch-action: manipulation;                  /* faster taps, avoid double-tap zoom */
}

/* Allow visible focus for keyboard users */
:focus { outline: none; }
:focus-visible { outline: 2px solid rgba(0,255,120,0.6); outline-offset: 2px; }

/* === MINI FEED === */
#miniFeed{position:absolute;top:24px;right:24px;width:240px;height:180px;border-radius:10px;overflow:hidden;z-index:6;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(4px);cursor:grab;transition:box-shadow .3s ease, transform .4s ease;}
#miniFeed video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);opacity:0.9}
#miniFeed:hover{box-shadow:0 0 20px rgba(0,255,120,0.25);transform:scale(1.04)}

/* === PROMPT / DICTATION === */
#promptWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:5;pointer-events:none}
#promptBox{pointer-events:auto;background:rgba(0,255,100,0.08);border:1px solid rgba(0,255,100,0.25);border-radius:10px;padding:.6rem 1rem;font-size:1.0rem;display:flex;align-items:center;gap:.4rem;color:#0f0;min-width:36vw;max-width:78vw}
#input{background:transparent;border:none;outline:none;color:#fff;font-size:inherit;width:28ch}
#caret{width:.25ch;height:1.3em;background:#0f0;animation:blink 1s step-end infinite}@keyframes blink{50%{opacity:0}}
#dictateBtn{background:transparent;border:1px solid rgba(0,255,120,0.12);color:#0f0;padding:6px 8px;border-radius:8px;cursor:pointer}

/* === TICKER === */
#ticker{position:fixed;left:14px;bottom:14px;width:38%;max-height:55%;display:flex;flex-direction:column-reverse;overflow:hidden;z-index:4;font-size:.95rem;line-height:1.15rem;color:#0f0}
.tline{opacity:.8;margin:0;animation:fadeIn 1s ease forwards;transition:opacity 45s linear}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:.8;transform:translateY(0)}}

/* === HUD / NAV === */
#hudToggle{position:fixed;top:12px;right:12px;z-index:8;background:rgba(0,255,80,0.1);border:1px solid rgba(0,255,120,0.2);border-radius:6px;color:#0f0;padding:6px 10px;cursor:pointer}
#hudToggle_nav{position:fixed;top:56px;right:12px;z-index:8;background:rgba(0,255,80,0.1);border:1px solid rgba(0,255,120,0.2);border-radius:6px;color:#0f0;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:.5rem;user-select:none}
#hudToggle_nav.holding{background:linear-gradient(90deg,rgba(255,12,110,0.26),rgba(255,40,140,0.12));box-shadow:0 0 64px rgba(255,12,110,0.95);transform:scale(1.02)}
#hudToggle_nav .holdProgress{position:absolute;left:0;top:0;height:100%;width:0%;border-radius:6px;background:linear-gradient(90deg,rgba(255,12,110,0.28),rgba(255,60,160,0.16));pointer-events:none;z-index:-1}
#repoStatus{position:fixed;right:14px;top:108px;color:#7fffb0;z-index:8}

/* === REPO NAV SIDEBAR === */
.repo-nav{position:fixed;top:0;right:0;height:100%;width:360px;max-width:90%;background:linear-gradient(180deg,rgba(0,0,0,0.9),rgba(0,0,0,0.85));border-left:1px solid rgba(0,255,120,0.08);padding:12px;transform:translateX(100%);transition:transform .28s cubic-bezier(.2,.9,.3,1),opacity .28s;opacity:0;pointer-events:none;z-index:9;display:flex;flex-direction:column}
.repo-nav.open{transform:translateX(0);opacity:1;pointer-events:auto}
.repo-nav header{display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px dashed rgba(0,255,120,0.06);padding-bottom:8px;margin-bottom:6px}
.repo-nav .list{display:block;overflow:auto;padding-right:8px}
.repo-nav a{display:block;padding:6px 8px;border-radius:6px;color:#9ffea0;text-decoration:none;font-size:13px;margin:4px 0}
.repo-nav a:hover{background:rgba(0,255,120,0.04);text-decoration:underline}
.repo-nav .meta{font-size:11px;color:#7fffb0;opacity:.8;margin-bottom:8px}

@media (max-width:640px){.repo-nav{width:92%}#miniFeed{width:180px;height:140px}}
</style>
</head>
<body>
<video id="camera" autoplay muted playsinline style="display:none;"></video>

<div id="miniFeed" style="left:auto;top:24px;right:24px;">
  <video id="miniVideo" autoplay muted playsinline></video>
</div>

<div id="hudToggle">‚ßâ FLOAT</div>

<div id="hudToggle_nav" role="button" aria-pressed="false" aria-label="Hold to open navigation">
  <div class="holdProgress" aria-hidden="true" style="position:absolute;"></div>
  ‚ßâ NAV
</div>

<div id="repoStatus">nav: idle</div>

<aside id="repoNav" class="repo-nav" aria-hidden="true">
  <header>
    <div>
      <div style="font-family:inherit;font-weight:700">Repository navigation</div>
      <div class="meta" id="repoMeta">local mode</div>
    </div>
    <div class="controls">
      <button id="repoRefresh" title="Refresh">‚ü≥</button>
      <button id="repoClose" title="Close">‚úï</button>
    </div>
  </header>
  <nav id="repoList" class="list" role="navigation" aria-label="Repository files"></nav>
  <div style="margin-top:auto;font-size:12px;color:#9ffea0;opacity:.9;padding-top:10px">
    Tip: click the single link to go to the live site.
  </div>
</aside>

<div id="promptWrap">
  <div id="promptBox">
    <div id="caret"></div>
    <input id="input" type="text" spellcheck="false" autocomplete="off" placeholder="ask or speak..." />
    <button id="dictateBtn" type="button" aria-label="Start dictation" title="Start dictation">üé§</button>
  </div>
</div>

<div id="ticker"></div>

<!-- lightweight local script -->
<script>
/* Safe/test bbc2.html for CodePen / iPad preview:
   - no camera getUserMedia in this patched build (disabled)
   - local/fallback RepoNav that only shows Index link
   - robust handlers for drag and hold-to-open
   - tap highlight and touch-focus sticking prevented via CSS + JS
*/

function addTickerLine(text, cls){
  const ticker=document.getElementById('ticker');
  if(!ticker) return;
  const el=document.createElement('div');
  el.className='tline'+(cls? ' '+cls:'');
  el.textContent=text;
  ticker.prepend(el);
  if(ticker.children.length>40) ticker.removeChild(ticker.lastChild);
  setTimeout(()=>{ el.style.opacity = 0.15; }, 45000);
}
addTickerLine('Patched safe build ‚Äî tap highlight disabled', 'note');

function setRepoStatus(msg){ var el=document.getElementById('repoStatus'); if(el) el.textContent = 'nav: '+msg; }

/* Robust draggable mini feed */
(function makeMiniDraggable(){
  const el = document.getElementById('miniFeed');
  if(!el) return;
  let down=false, ox=0, oy=0;
  function getClient(e){
    if(e.touches && e.touches[0]) return {x:e.touches[0].clientX,y:e.touches[0].clientY};
    if(e.changedTouches && e.changedTouches[0]) return {x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};
    return {x:e.clientX,y:e.clientY};
  }
  const start = evt => { const p=getClient(evt); down=true; ox=p.x - el.offsetLeft; oy=p.y - el.offsetTop; el.style.cursor='grabbing'; };
  const move = evt => { if(!down) return; const p=getClient(evt); el.style.left=(p.x-ox)+'px'; el.style.top=(p.y-oy)+'px'; if(evt.preventDefault) evt.preventDefault(); };
  const stop = () => { down=false; el.style.cursor='grab'; };
  el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive:false});
  window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive:false});
  window.addEventListener('mouseup', stop); window.addEventListener('touchend', stop);
})();

/* Toggle mini feed */
const miniBtn = document.getElementById('hudToggle');
if(miniBtn) miniBtn.addEventListener('click', ()=>{ const m=document.getElementById('miniFeed'); if(m) m.style.display = m.style.display==='none'?'block':'none'; });

/* Local/fallback RepoNav (no network). Shows a single Index link. */
(function globalRepoNavFactory(){
  function RepoNav(opts){
    this.container = document.getElementById(opts.containerId || 'repoNav');
    this.list = document.getElementById(opts.listId);
    this.meta = document.getElementById(opts.metaId);
    this.statusEl = document.getElementById('repoStatus');
    if(this.meta) this.meta.textContent = (opts.owner? opts.owner + '/'+ opts.repo : 'local') + ' ¬∑ local';
  }
  RepoNav.prototype.refresh = async function(){
    if(this.list) this.list.innerHTML = '<a href="https://jeff-gompertz.github.io/CUseeme/index.html" target="_self">üè† Index</a>';
    if(this.statusEl) setRepoStatus('loaded');
  };
  RepoNav.prototype.open = async function(){ if(this.container) this.container.classList.add('open'); await this.refresh(); };
  RepoNav.prototype.close = function(){ if(this.container) this.container.classList.remove('open'); };
  window.createRepoNav = function(opts){ return new RepoNav(opts||{}); };
})();

/* instantiate */
var repoNavInstance = createRepoNav({ owner:'jeff-gompertz', repo:'CUseeme', branch:'main', containerId:'repoNav', listId:'repoList', metaId:'repoMeta' });

/* Hold-to-open wiring (safe) */
(function attachHoldToOpen(){
  const btn = document.getElementById('hudToggle_nav');
  if(!btn) return;
  const progress = btn.querySelector('.holdProgress');
  const HOLD_MS = 1000;
  let holdTimer = null, startX=0, startY=0, triggered=false, moved=false, maxMove=12, lastOpenedAt=0;

  function setProgress(p){ if(progress) progress.style.width = Math.max(0, Math.min(100, p*100)) + '%'; }
  function startHold(x,y){
    triggered=false; moved=false; startX=x; startY=y; btn.classList.add('holding'); setProgress(0);
    if(progress){ progress.style.transition = 'width '+HOLD_MS+'ms linear'; setTimeout(()=>progress.style.width='100%',10); }
    holdTimer = setTimeout(()=>{
      triggered=true; btn.setAttribute('aria-pressed','true'); lastOpenedAt=Date.now();
      if(repoNavInstance && repoNavInstance.open) repoNavInstance.open();
      setRepoStatus('opened'); clearHoldVisual();
    }, HOLD_MS);
    setRepoStatus('holding');
  }
  function clearHoldVisual(){ btn.classList.remove('holding'); if(progress){ progress.style.transition='width 160ms linear'; progress.style.width='0%'; } if(holdTimer){ clearTimeout(holdTimer); holdTimer=null; } setTimeout(()=>{ if(btn.getAttribute('aria-pressed')==='true') btn.setAttribute('aria-pressed','false'); },350); }
  function cancelHold(){ if(holdTimer){ clearTimeout(holdTimer); holdTimer=null; } triggered=false; clearHoldVisual(); setRepoStatus('idle'); }

  btn.addEventListener('touchstart', e => { const t=e.touches && e.touches[0]; if(!t) return; startHold(t.clientX,t.clientY); }, {passive:true});
  btn.addEventListener('touchmove', e => { const t=e.touches && e.touches[0]; if(!t) return; if(Math.abs(t.clientX-startX)>maxMove||Math.abs(t.clientY-startY)>maxMove){ moved=true; cancelHold(); } }, {passive:true});
  btn.addEventListener('touchend', e => { if(triggered) clearHoldVisual(); else cancelHold(); });
  btn.addEventListener('touchcancel', cancelHold);

  btn.addEventListener('mousedown', e => {
    if(e.button!==0) return;
    startHold(e.clientX,e.clientY);
    function onMove(ev){ if(Math.abs(ev.clientX-startX)>maxMove||Math.abs(ev.clientY-startY)>maxMove){ moved=true; cancelHold(); document.removeEventListener('mousemove',onMove); } }
    function onUp(ev){ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); if(triggered) clearHoldVisual(); else cancelHold(); }
    document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
  });

  btn.addEventListener('keydown', e => { if(e.key===' '||e.key==='Enter'){ startHold(0,0); } });
  btn.addEventListener('keyup', e => { if(e.key===' '||e.key==='Enter'){ if(holdTimer) cancelHold(); else clearHoldVisual(); } });

  const closeBtn = document.getElementById('repoClose');
  if(closeBtn) closeBtn.addEventListener('click', ()=>{ if(repoNavInstance) repoNavInstance.close(); setRepoStatus('idle'); });

  document.addEventListener('click', function(e){
    const nav = document.getElementById('repoNav'); const toggle = document.getElementById('hudToggle_nav');
    if(!nav.contains(e.target) && !toggle.contains(e.target)){ if(Date.now()-lastOpenedAt<350) return; if(repoNavInstance) repoNavInstance.close(); }
  });
})();

/* Prevent touch-caused focus sticking (keeps keyboard focus intact) */
(function preventTouchFocusSticking(){
  let lastTouch = 0;
  document.addEventListener('touchstart', ()=>{ lastTouch = Date.now(); }, {passive:true});
  document.addEventListener('focusin', (e)=>{
    if(Date.now() - lastTouch < 500 && e.target && (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.getAttribute('role') === 'button')){
      try { e.target.blur(); } catch(e){}
    }
  }, true);
})();

/* Lightweight input/dictation fallback */
const input = document.getElementById('input');
if(input){
  input.addEventListener('keydown', e=>{
    if(e.key === 'Enter'){ e.preventDefault(); const v=input.value.trim(); if(!v) return; addTickerLine('> '+v); input.value=''; setTimeout(()=>addTickerLine('< echo: '+v),300); }
  });
}
(function dictationFallback(){ const btn=document.getElementById('dictateBtn'); if(!btn) return; btn.addEventListener('click', ()=>{ try{ input && input.focus(); }catch(e){} addTickerLine('‚Üí Focused input (use keyboard mic on mobile)'); }); })();
</script>
</body>
</html>
