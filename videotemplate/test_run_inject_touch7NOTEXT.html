<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CUSeeMe ‚Äî Injected RGB Scan Raster (with Debug, no input)</title>
  <style>
    :root { --hud-bg: transparent; --ticker: #ff3a2f; }
    html,body{height:100%;margin:0;background:transparent;font-family:"VT323", ui-monospace, Menlo, Consolas, monospace;color:#222;}
    #bgVideo {position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:-3;}
    #gridCanvas {position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-2;display:block;background:black;}
    #hudWrapper{position:fixed;top:12px;left:18px;z-index:100;}
    .hud-row{display:flex;gap:12px;justify-content:space-between;}
    .hud-btn{flex:1;font-family:"VT323",monospace;font-size:17px;color:#132030;
      background:rgba(215,235,255,0.35);border:none;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,0.08);
      padding:10px 12px;cursor:pointer;transition:all .22s ease;}
    .miniWin{position:absolute;width:66vw;max-width:380px;aspect-ratio:9/12;background:rgba(210,240,255,0.25);
      border:1px solid rgba(255,255,255,0.55);border-radius:16px;backdrop-filter:blur(12px);
      box-shadow:0 18px 40px rgba(0,0,0,0.25);overflow:hidden;cursor:grab;z-index:500;}
    .miniBar{display:flex;align-items:center;justify-content:space-between;padding:4px 10px;height:26px;
      background:rgba(255,255,255,0.18);font-size:12px;color:#222;user-select:none;}
    .miniInner{position:relative;width:100%;height:calc(100% - 26px);}
    .miniVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:black;}
    #ticker{position:fixed;left:16px;bottom:14px;z-index:900;width:45vw;max-width:700px;max-height:50vh;display:flex;flex-direction:column-reverse;overflow:hidden;color:var(--ticker);font-size:18px;line-height:1.25;}
    .tline{opacity:.95;margin:0;animation:fadeIn .6s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    @media (max-width:700px){.miniWin{left:4vw!important;right:auto!important;max-width:90vw!important;width:90vw!important;}}
    .source-toggle-row{margin-bottom:10px;}
    #scanUI { margin-top:10px; font-family: system-ui, sans-serif; font-size:12px; color:#132030; }
    #scanUI label{display:inline-block;min-width:120px;}
    #scanUI input[type=range]{width:140px;}
    #debugTicker { position: fixed; right: 12px; top: 12px; z-index: 100000; max-width: 360px; max-height: 45vh; overflow:auto; font-family: monospace; font-size:12px; color:#ffd; pointer-events:none; }
    #debugTicker .tline { margin: 2px 0; opacity: 0.9; }
  </style>
</head>
<body>
  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="" type="video/mp4" />
  </video>
  <canvas id="gridCanvas"></canvas>
  <video id="cameraMain" autoplay muted playsinline style="display:none"></video>

  <div id="hudWrapper">
    <div class="source-toggle-row">
      <label><b>Source:</b>
        <select id="sourceSelect">
          <option value="grid">Scan Raster (default)</option>
          <option value="camera">Live Camera (raw)</option>
          <option value="video">Background Video</option>
        </select>
      </label>
    </div>
    <div id="hudShell">
      <div id="hudHeader">Visual Source Demo</div>
      <div id="hud1" class="hud-panel active">
        <div class="hud-row">
          <button class="hud-btn" id="btnSpawn5">‚ûï Spawn 5</button>
          <button class="hud-btn" id="btnReverseCam">üîÅ Reverse Cam</button>
        </div>
        <div class="hud-row">
          <button class="hud-btn" id="btnCloseAll">‚úï Close All</button>
        </div>
        <div id="scanUI">
          <!-- Scan controls unchanged -->
          <div style="margin-top:8px;font-weight:600">Scan Controls</div>
          <div><label>Direction</label><select id="dir"><option value="rtl" selected>Right ‚Üí Left</option><option value="ltr">Left ‚Üí Right</option></select></div>
          <div><label>Stripe width</label><input id="stripe" type="range" min="1" max="120" value="4"><output id="stripe_out">4</output></div>
          <div><label>Speed (px/s)</label><input id="speed" type="range" min="0.5" max="240" value="36"><output id="speed_out">36</output></div>
          <div><label>Jitter</label><input id="jitter" type="range" min="0" max="1" step="0.01" value="0.06"><output id="jitter_out">0.06</output></div>
          <div><label>Blend</label><input id="blend" type="range" min="0" max="1" step="0.01" value="1"><output id="blend_out">1.00</output></div>
          <div style="margin-top:8px;font-weight:600">RGB Split</div>
          <div><label>Split px</label><input id="split" type="range" min="0" max="20" value="6"><output id="split_out">6</output></div>
          <div><label>Intensity</label><input id="proc_int" type="range" min="0" max="1" step="0.01" value="1"><output id="proc_int_out">1.00</output></div>
          <div><label>Sample res</label><select id="sampleRes"><option value="64">64</option><option value="128" selected>128</option><option value="256">256</option></select></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="btn_clear" class="hud-btn">Clear</button>
            <button id="btn_pause" class="hud-btn">Pause</button>
            <button id="btn_reset" class="hud-btn">Reset Scan</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="ticker"></div>
  <div id="debugTicker" aria-hidden="false"></div>

<script>
/* ====== canvas, camera, scan painter, debug code unchanged ====== */
/* ...all original scan and painter code remains here unchanged... */

/* ====== mini-window spawn & drag (EXOTIC BLOCK) ====== */
let winCount = 0, spawnUsed = false;

/**
 * üü™ makeMiniWindow({x, y}) ‚Äî spawns a draggable scan window at X and Y.
 * - x: horizontal (how far from the LEFT edge, in pixels)
 * - y: vertical (how far from TOP, in pixels)
 */
function makeMiniWindow({x=150, y=300} = {}) {
  // üõë BLOCKER WARNING üõë
  // If you uncomment this line, it will "clamp" windows to the far left on mobile/tablet
  // (window.innerWidth < 700) means "phone/tablet"
  // if(window.innerWidth < 700 && x > 20) x = 20; // REMOVE/COMMENT for free X placement!
  winCount++;
  const el = document.createElement('div');
  el.className = 'miniWin';
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.innerHTML = `
    <div class="miniBar">
      <div class="miniTitle">window_${String(winCount).padStart(4,'0')}</div>
      <div class="miniBtns"><div class="win-dot"></div><div class="win-dot"></div><div class="win-dot"></div></div>
    </div>
    <div class="miniInner"><video class="miniVideo" autoplay muted playsinline></video></div>
  `;
  document.body.appendChild(el);
  const v = el.querySelector('.miniVideo');
  v.srcObject = getActiveSourceStream();
  v.play().catch(()=>{});

  // Drag logic
  const bar = el.querySelector('.miniBar');
  let dragging = false, sx = 0, sy = 0, sl = 0, st = 0;
  function start(e) {
    dragging = true;
    const r = el.getBoundingClientRect(); sl = r.left; st = r.top;
    sx = (e.touches ? e.touches[0].clientX : e.clientX);
    sy = (e.touches ? e.touches[0].clientY : e.clientY);
    document.addEventListener('pointermove', move);
    document.addEventListener('pointerup', stop);
    document.addEventListener('touchmove', move, { passive:false });
    document.addEventListener('touchend', stop);
  }
  function move(e) {
    if (!dragging) return;
    const cx = (e.touches ? e.touches[0].clientX : e.clientX);
    const cy = (e.touches ? e.touches[0].clientY : e.clientY);
    el.style.left = (sl + (cx - sx)) + 'px';
    el.style.top  = (st + (cy - sy)) + 'px';
    e.preventDefault?.();
  }
  function stop() {
    dragging = false;
    document.removeEventListener('pointermove', move);
    document.removeEventListener('pointerup', stop);
    document.removeEventListener('touchmove', move);
    document.removeEventListener('touchend', stop);
  }
  bar.addEventListener('pointerdown', start);
  bar.addEventListener('touchstart', start, { passive:false });
  return el;
}

document.getElementById('btnSpawn5').addEventListener('click', ()=>{
  if(spawnUsed) return addTicker('spawn blocked: already active');
  spawnUsed = true;
  let startX = 170 + Math.random()*40, startY = 300 + Math.random()*40;
  if(window.innerWidth < 700) startX = 40;
  for(let i=0;i<5;i++) makeMiniWindow({ x: startX + i*26, y: startY + i*18 });
  addTicker('spawned 5 windows');
});
document.getElementById('btnCloseAll').addEventListener('click', ()=>{
  document.querySelectorAll('.miniWin').forEach(n=>n.remove());
  winCount = 0; spawnUsed = false;
  addTicker('all windows closed');
});
document.getElementById('btnReverseCam').addEventListener('click', async ()=>{
  facing = (facing === 'user') ? 'environment' : 'user';
  await startCamera();
});

/* initial spawn windows for demo */
(function initialSpawn(){
  let startX = 100, startY = 170;
  if(window.innerWidth < 700) startX = 40;
  for(let i=0;i<5;i++) makeMiniWindow({ x: startX + i*22, y: startY + i*18 });
})();

/* HUD panel switching and ticker */
const huds = [...document.querySelectorAll('.hud-panel')];
const hudIndex = document.getElementById('hudIndex');
let currentHUD = 0;
function updateHUDLabel(){
  hudIndex.textContent = `HUD ${currentHUD + 1} / ${huds.length}`;
}
function showHUD(i){
  huds[currentHUD].classList.remove('active');
  currentHUD = (i + huds.length) % huds.length;
  huds[currentHUD].classList.add('active');
  updateHUDLabel();
  addTicker(`HUD switched ‚Üí ${currentHUD + 1}`);
}
document.getElementById('hudHeader').addEventListener('click',()=>showHUD(currentHUD + 1));
updateHUDLabel();

/* =========================
   Debug wrapper unchanged, left for instrumentation
   ========================= */
(function installDebugWrapper(){ /* ...code unchanged... */ })();
</script>

<!-- Advance Button section unchanged -->
<button id="advanceButtonGlobal"
        type="button"
        role="button"
        aria-pressed="false"
        title="Hold to advance"
        tabindex="0"
        data-longpress-url="https://jeff-gompertz.github.io/CUseeme/videotemplate/test_run_inject_touch6.html"
>
  <span class="ab-progress" aria-hidden="true"></span>
  <span class="ab-label">Advance</span>
</button>
<style>/* ...Button CSS unchanged... */</style>
<script>/* ...Button JS unchanged... */</script>
</body>
</html>
