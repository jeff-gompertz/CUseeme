

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

 <link rel="stylesheet" href="css/neumorphic_neutral.css">  
  
<title>CUSeeMe ‚Äî Scene 3 (Semantic Feed + Neumorphic Header)</title>

<!-- Icons for header -->
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v6.0.0-beta1/css/all.css">

<style>
/* ---------- Base ---------- */
html,body{
  margin:0; height:100%;
  background:#ffffff; /* pure white */
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  overflow:hidden;
}

/* ---------- Neumorphic Header (6 buttons) ---------- */
header{
  position:fixed; top:0; left:0; width:100%;
  background:#e5e9f4;
  box-shadow:0 5px 10px rgba(0,0,0,.05);
  z-index:2000;
  display:flex; justify-content:center;
  padding:1rem 0;
}
.buttons{
  display:grid;
  grid-template-columns:repeat(6, minmax(60px,1fr));
  gap:1rem;
  width:min(90vw, 500px);
}
button.neumorphic{
  border:.5rem solid transparent;
  border-radius:1rem;
  color:hsl(0 0% 10%);
  background:none;
  display:grid; place-content:center; gap:.5rem;
  --shadow: -.5rem -.5rem 1rem hsl(0 0% 100%/.75),
             .5rem .5rem 1rem hsl(0 0% 50%/.5);
  box-shadow:var(--shadow);
  outline:none; transition:all .1s;
  user-select:none;
}
button.neumorphic:hover,
button.neumorphic:focus-visible{ color:hsl(10 80% 50%); scale:1.05; }
button.neumorphic:active,
button.neumorphic.active{
  box-shadow:var(--shadow),
             inset .5rem .5rem 1rem hsl(0 0% 50%/.5),
             inset -.5rem -.5rem 1rem hsl(0 0% 100%/.75);
  color:hsl(10 80% 50%);
}
button.neumorphic>i{ font-size:20px; }
button.neumorphic>span{ font-size:12px; }

/* mobile fit */
@media (max-width:600px){
  .buttons{ grid-template-columns:repeat(auto-fit, minmax(50px,1fr)); width:95vw; gap:.5rem; }
  button.neumorphic>i{ font-size:16px; }
  button.neumorphic>span{ font-size:10px; }
}

/* ---------- Main area (beneath header) ---------- */
main{
  position:relative;
  height:100%;
  padding-top:110px; /* header offset */
}

/* ---------- Mini windows (Spawn 5) ---------- */
.miniWin{
  position:absolute;
  width:min(24vw, 320px);
  aspect-ratio:9/16;
  background:rgba(210,240,255,.25);
  border:1px solid rgba(255,255,255,.55);
  border-radius:16px;
  backdrop-filter:blur(12px);
  box-shadow: inset 0 1px 2px rgba(255,255,255,.6),
              0 18px 40px rgba(0,0,0,.25);
  overflow:hidden; cursor:grab; z-index:1200;
}
.miniWin:active{ cursor:grabbing; }
.miniBar{
  display:flex; align-items:center; justify-content:space-between;
  padding:4px 10px; height:26px;
  background:rgba(255,255,255,.18);
  font-size:12px; color:#222; user-select:none;
}
.miniInner{ position:relative; width:100%; height:calc(100% - 26px); }
.miniVideo{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }

/* ---------- BBC Semantic Feed HUD (your original box) ---------- */
:root{
  --hud-glass: rgba(185,225,255,.45);
  --hud-border-light: rgba(255,255,255,.65);
  --hud-border-dark: rgba(0,45,90,.35);
  --hud-shadow: 0 12px 45px rgba(0,50,90,.35);
  --hud-text:#1b1d22;
  --btn-bg: rgba(215,235,255,.35);
  --ticker:#ff3a2f;
}
#hudShell{
  position:fixed; top:140px; right:32px; /* pushed below header */
  z-index:1100;
  display:grid; gap:10px; padding:20px 18px 16px; min-width:320px;
  text-align:center; color:var(--hud-text);
  background:var(--hud-glass);
  border-radius:18px; border:1px solid var(--hud-border-light);
  box-shadow: inset 0 1px 3px var(--hud-border-light),
              inset 0 -1px 3px var(--hud-border-dark),
              var(--hud-shadow);
  backdrop-filter: blur(20px) saturate(1.25);
  -webkit-backdrop-filter: blur(20px) saturate(1.25);
}
#hudHeader{ font-size:22px; color:rgba(20,30,45,.85); text-shadow:0 1px 0 rgba(255,255,255,.6); user-select:none; }
.hud-row{ display:flex; gap:10px; }
.hud-btn{
  flex:1; font:inherit; font-size:17px; cursor:pointer;
  color:#132030; background:var(--btn-bg); border:none; border-radius:10px; padding:10px 12px;
  box-shadow: inset 1px 1px 2px rgba(255,255,255,.8),
              inset -1px -2px 3px rgba(0,30,60,.3),
              0 3px 6px rgba(0,0,0,.08);
  transition:all .22s ease;
}
.hud-btn:hover{ transform:translateY(-1px); }
#input{
  width:100%; font:inherit; font-size:18px; color:#111;
  background:rgba(255,255,255,.6); border:1px solid rgba(0,30,60,.15);
  border-radius:10px; padding:10px 12px; outline:none;
}

/* ---------- Ticker ---------- */
#ticker{
  position:fixed; left:16px; bottom:14px; z-index:1000;
  width:45vw; max-width:700px;
  display:flex; flex-direction:column-reverse;
  overflow:visible; height:auto;
  color:var(--ticker); font-size:19px; line-height:1.5;
  pointer-events:none;
}
.tline{ opacity:.95; margin:2px 0; animation:fadeIn .6s ease; }
@keyframes fadeIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }

/* ---------- Hide raw Bloople anchors ---------- */
a{ pointer-events:none !important; cursor:default !important; text-decoration:none !important; }
body > a, body > b, body > h1, body > p{ display:none !important; }
#rssSource, #rssSource *{ display:none !important; }

/* --- TEMP PATCH: visually suppress legacy Aqua HUD shell --- */
#hudShell {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
  opacity: 0 !important;
}

<link rel="stylesheet" href="css/neumorphic_neutral.css">   
  
</style>
</head>

<body>

<!-- ===== Neumorphic Header ===== -->
<header>
  <div class="buttons" id="headerButtons">
    <button class="neumorphic" id="hSpawn"><i class="fa-light fa-sparkles"></i><span>Spawn 5</span></button>
    <button class="neumorphic" id="hReverse"><i class="fa-light fa-camera-rotate"></i><span>Reverse</span></button>
    <button class="neumorphic" id="hVoice"><i class="fa-light fa-waveform-lines"></i><span>Voice</span></button>
    <button class="neumorphic" id="hClose"><i class="fa-light fa-xmark"></i><span>Close All</span></button>
    <button class="neumorphic" id="hNext"><i class="fa-light fa-arrow-right"></i><span>Next</span></button>
    <button class="neumorphic" id="hReturn"><i class="fa-light fa-arrow-left"></i><span>Return</span></button>
  </div>
</header>

<main>
  <!-- ===== Your original Semantic Feed HUD ===== -->
  <div id="hudShell">
    <div id="hudHeader">Semantic Feed ‚Äî BBC Reactive</div>
    <input id="input" placeholder="speak or type‚Ä¶ then Enter" autocomplete="off" />
    <div class="hud-row">
      <button id="btnMic"  class="hud-btn" title="Start/Stop mic">üéôÔ∏è Mic</button>
      <button id="btnMute" class="hud-btn" title="Toggle spoken replies">üîä Voice On</button>
      <button id="btnNextHUD" class="hud-btn" title="Next HUD">‚û° Mode Shift</button>
    </div>
  </div>

  <!-- Ticker -->
  <div id="ticker"></div>

  <!-- Bloople BBC (no CORS) -->
  <div id="rssSource" style="display:none;"></div>
  <script src="//rss.bloople.net/?url=https%3A%2F%2Ffeeds.bbci.co.uk%2Fnews%2Fworld%2Frss.xml&showtitle=false&type=js"></script>
</main>

<script>
/* =========================================================
Camera stream for Spawn/Reverse (shared across scenes)
========================================================= */
let mediaStream = null;
let facing = 'environment';

async function initStream(){
  if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: facing } },
      audio: false
    });
    // attach to any existing mini windows
    document.querySelectorAll('.miniVideo').forEach(v=>v.srcObject = mediaStream);
  }catch(e){
    addLine && addLine('‚ö† camera denied/unavailable','note');
    console.error(e);
  }
}
</script>

<script>
/* =========================================================
Mini-window system (Spawn 5) ‚Äî centered cluster
========================================================= */
let winCount = 0, spawnUsed = false;

function makeMiniWindow({x=0,y=0}={}){
  winCount++;
  const el = document.createElement('div');
  el.className = 'miniWin';
  el.style.left = x+'px';
  el.style.top  = y+'px';
  el.innerHTML = `
    <div class="miniBar">
      <div class="miniTitle">subject_${String(winCount).padStart(4,'0')}</div>
      <div class="miniBtns"><div class="win-dot"></div><div class="win-dot"></div><div class="win-dot"></div></div>
    </div>
    <div class="miniInner"><video class="miniVideo" autoplay muted playsinline></video></div>
  `;
  document.body.appendChild(el);

  const v = el.querySelector('.miniVideo');
  if (mediaStream) v.srcObject = mediaStream;

  // drag
  const bar = el.querySelector('.miniBar');
  let dragging=false, sx=0, sy=0, sl=0, st=0;
  function start(e){
    dragging=true;
    const r=el.getBoundingClientRect(); sl=r.left; st=r.top;
    sx=(e.touches?e.touches[0].clientX:e.clientX);
    sy=(e.touches?e.touches[0].clientY:e.clientY);
    document.addEventListener('pointermove',move);
    document.addEventListener('pointerup',stop);
    document.addEventListener('touchmove',move,{passive:false});
    document.addEventListener('touchend',stop);
  }
  function move(e){
    if(!dragging) return;
    const cx=(e.touches?e.touches[0].clientX:e.clientX);
    const cy=(e.touches?e.touches[0].clientY:e.clientY);
    el.style.left=(sl+(cx-sx))+'px';
    el.style.top =(st+(cy-sy))+'px';
    e.preventDefault?.();
  }
  function stop(){
    dragging=false;
    document.removeEventListener('pointermove',move);
    document.removeEventListener('pointerup',stop);
    document.removeEventListener('touchmove',move);
    document.removeEventListener('touchend',stop);
  }
  bar.addEventListener('pointerdown',start);
  bar.addEventListener('touchstart',start,{passive:false});
  return el;
}

function spawnFiveCentered(){
  if (spawnUsed) return addLine('spawn blocked: already active','note'), null;
  spawnUsed = true;

  const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
  const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);

  const boxW = Math.min(vw*0.24, 320);
  const boxH = boxW * (16/9); // because video is 9/16 portrait, container aspect set earlier

  // center start
  const cx = (vw - boxW)/2;
  const cy = (vh - boxH)/2;

  const offsets = [
    {dx: -40, dy: -30},
    {dx:  40, dy: -30},
    {dx: -40, dy:  30},
    {dx:  40, dy:  30},
    {dx:   0, dy:   0},
  ];
  offsets.forEach(({dx,dy})=>{
    makeMiniWindow({x: cx + dx, y: cy + dy});
  });
  addLine('spawned 5 windows','note');
}

function closeAllWindows(){
  document.querySelectorAll('.miniWin').forEach(n=>n.remove());
  winCount = 0; spawnUsed = false;
  addLine('all windows closed','note');
}
</script>

<script>
/* =========================================================
BBC Semantic feed (unchanged from your v2.1)
========================================================= */
speechSynthesis.cancel();

const ticker = document.getElementById('ticker');
function addLine(text, cls='sys'){
  const el = document.createElement('div');
  el.className = `tline ${cls}`;
  el.textContent = text;
  ticker.prepend(el);
}

addLine('v2.1 online ‚Äî semantic core + BBC reactive blending','note');
addLine('Mic optional. Typing always works. Say: "time?", "repeat after me ‚Ä¶", or anything.','note');

let speakEnabled = true;
let voicesReady = false;
function waitVoices(){
  return new Promise(res=>{
    const id=setInterval(()=>{
      if (speechSynthesis.getVoices().length){ clearInterval(id); voicesReady=true; res(); }
    },100);
  });
}
async function speak(text){
  if(!speakEnabled || !('speechSynthesis' in window)) return;
  if(!voicesReady) await waitVoices();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-GB'; u.rate=1.02; u.pitch=.95; u.volume=.9;
  const v = speechSynthesis.getVoices();
  u.voice = v.find(x=>/en-GB|UK|Kate|Samantha|Google UK English/i.test(x.name)) || v[0];
  speechSynthesis.speak(u);
}
document.getElementById('btnMute').addEventListener('click', ()=>{
  speakEnabled = !speakEnabled;
  const b = document.getElementById('btnMute');
  b.textContent = speakEnabled ? 'üîä Voice On' : 'üîá Voice Off';
  b.classList.toggle('on', speakEnabled);
  addLine(`Spoken replies ${speakEnabled?'enabled':'disabled'}`,'note');
});

window.addEventListener('touchstart',()=>{ try{ speechSynthesis.speak(new SpeechSynthesisUtterance('')); }catch(_){} }, {once:true});

let feedBuffer = [];
function harvestHeadlines(){
  const anchors = Array.from(document.body.querySelectorAll('a'));
  const titles = anchors.map(a=>(a.textContent||'').trim()).filter(Boolean);
  const now = Date.now();
  titles.forEach(t=>{
    if(!feedBuffer.some(x=>x.title===t)){ feedBuffer.push({title:t, ts:now}); }
  });
  if(feedBuffer.length>80) feedBuffer = feedBuffer.slice(-80);
}
setTimeout(harvestHeadlines,1500);
setInterval(harvestHeadlines,60000);

setTimeout(()=>{
  document.querySelectorAll('a').forEach(a=>{
    a.removeAttribute('href');
    a.style.color = 'rgba(0,0,0,0)';
    a.style.pointerEvents = 'none';
    a.style.textDecoration = 'none';
  });
},3000);

function keywordsFrom(text){
  return (text.toLowerCase()
    .replace(/[^a-z0-9\s]/g,' ')
    .split(/\s+/)
    .filter(w => w.length > 3 && !'about with into from that this what your have just will been they them than then here there which where only also because while after before could would should doing being hello thank'.includes(w))
  );
}

function blendWithFeed(userText){
  if(feedBuffer.length===0) return null;
  const keys = keywordsFrom(userText);
  let candidates = [];

  if(keys.length){
    candidates = feedBuffer
      .map(h=>{
        const score = keys.reduce((s,k)=> s + (h.title.toLowerCase().includes(k)?1:0), 0);
        return {...h, score};
      })
      .filter(x=>x.score>0)
      .sort((a,b)=>b.score-a.score);
  }
  if(candidates.length===0){
    const pool = feedBuffer.slice(-20);
    for(let i=0;i<3 && pool.length;i++){
      const idx=Math.floor(Math.random()*pool.length);
      candidates.push(pool.splice(idx,1)[0]);
    }
  }

  const pick=(arr,n)=>{ const out=[]; const copy=arr.slice(); while(n-- > 0 && copy.length){ out.push(copy.splice(Math.floor(Math.random()*copy.length),1)[0]); } return out; };
  const chosen = pick(candidates,2).map(x=>x.title);
  const stems = ['signal echoes:','semantic crossover:','field resonance:','adjacent headline:','network murmur:','latent alignment:'];
  const stem = stems[Math.floor(Math.random()*stems.length)];

  if(chosen.length===1){ return `${stem} ${chosen[0]}`; }
  if(chosen.length===2){
    const [a,b]=chosen;
    const A=a.replace(/[‚Äì‚Äî-]\s.*$/,'').replace(/\.$/,'');
    const B=b.replace(/^[A-Z].{0,10}:\s*/,'');
    return `${stem} ${A} ‚Äî ${B}.`;
  }
  return 'channel quiet.';
}

function semanticRouter(raw){
  const text=(raw||'').trim();
  if(!text) return;
  addLine('> '+text,'user');

  const lower=text.toLowerCase();
  if(lower==='hello' || lower.startsWith('hi')){ const r="Hello. I'm listening."; addLine(r,'sys'); speak(r); }
  else if(lower.includes('time')){ const r='Current time: '+new Date().toLocaleTimeString(); addLine(r,'sys'); speak(r); }
  else if(lower.startsWith('repeat after me')){
    const say=text.replace(/^repeat after me/i,'').trim()||'‚Ä¶say what?';
    addLine(say,'sys'); speak(say);
  }else{
    const echo='You said: '+text; addLine(echo,'sys'); speak(echo);
  }

  const blend=blendWithFeed(text);
  if(blend){ setTimeout(()=>{ addLine(blend,'sys'); speak(blend); },500); }
}

const input=document.getElementById('input');
input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){ e.preventDefault(); semanticRouter(input.value); input.value=''; }
});

/* Simple Mic gate (no SR on this page to keep it light) */
document.getElementById('btnMic').addEventListener('click', ()=>{
  addLine('üéôÔ∏è (placeholder) voice capture toggle','note');
});
document.getElementById('btnNextHUD').addEventListener('click', ()=>{
  addLine('Mode shift (placeholder)','note');
});

setTimeout(()=> addLine('BBC headlines linked. Waiting for your input‚Ä¶','note'), 1200);
</script>

<script>
/* =========================================================
Header button wiring (shared scene semantics)
========================================================= */
const bSpawn  = document.getElementById('hSpawn');
const bRev    = document.getElementById('hReverse');
const bVoice  = document.getElementById('hVoice');
const bClose  = document.getElementById('hClose');
const bNext   = document.getElementById('hNext');
const bReturn = document.getElementById('hReturn');

bSpawn.addEventListener('click', async ()=>{
  if(!mediaStream) await initStream();
  spawnFiveCentered();
});
bRev.addEventListener('click', async ()=>{
  facing = (facing==='user')?'environment':'user';
  await initStream();
  addLine(`camera flipped ‚Üí ${facing}`,'note');
});
let headerVoiceOn=false;
bVoice.addEventListener('click', ()=>{
  headerVoiceOn = !headerVoiceOn;
  bVoice.classList.toggle('active', headerVoiceOn);
  speakEnabled = headerVoiceOn; // tie into semantic speak toggle
  addLine(`voice: ${headerVoiceOn?'enabled':'disabled'}`,'note');
});
bClose.addEventListener('click', closeAllWindows);

bNext.addEventListener('click', ()=>{
  // ‚Üí Scene 2
  window.location.href = 'video_scene2_.html';
});
bReturn.addEventListener('click', ()=>{
  // ‚Üí Scene 1
  window.location.href = 'video_scene1_live_portrait2.html';
});
</script>

</body>
</html>
