<!-- WP Custom HTML Block: Residue Cinema (full-bleed canvas crossfade, no Ken Burns) -->
<style>
  #rcWrap{position:fixed;inset:0;background:#000;overflow:hidden;z-index:999999;}
  #rcCanvas{position:absolute;inset:0;width:100%;height:100%;display:block;background:#000;}

  /* minimal overlay controls */
  #rcCtl{position:fixed;left:14px;bottom:14px;z-index:1000000;display:flex;gap:10px;
         pointer-events:auto;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;}
  .rcBtn{width:36px;height:36px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
         background:rgba(0,0,0,.55);color:#fff;font-size:16px;line-height:1;cursor:pointer;
         backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);-webkit-tap-highlight-color:transparent;
         touch-action:manipulation;display:flex;align-items:center;justify-content:center;}
  .rcBtn:active{transform:scale(.98);}

  /* MICRO NAV — three dots */
  #microNav{position:fixed;top:14px;right:14px;z-index:9999999;
            font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;}
  #microNavBtn{width:36px;height:36px;border-radius:999px;border:0;background:rgba(255,255,255,.18);
               color:#fff;font-size:20px;line-height:1;cursor:pointer;backdrop-filter:blur(6px);
               -webkit-backdrop-filter:blur(6px);-webkit-tap-highlight-color:transparent;}
  #microNavMenu{position:absolute;top:44px;right:0;min-width:170px;background:rgba(255,255,255,.92);
                color:#000;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:6px 0;
                display:none;overflow:hidden;}
  #microNavMenu a{display:block;padding:11px 14px;font-size:14px;text-decoration:none;color:#000;}
  #microNavMenu a:hover{background:rgba(0,0,0,.06);}
</style>

<div id="rcWrap">
  <canvas id="rcCanvas"></canvas>
  <div id="rcCtl" aria-label="controls">
    <button id="rcPlayPause" class="rcBtn" type="button" aria-label="Pause">⏸</button>
    <button id="rcNext" class="rcBtn" type="button" aria-label="Next">⟲</button>
    <button id="rcRefresh" class="rcBtn" type="button" aria-label="Refresh feed">↻</button>
  </div>
</div>

<!-- MicroNav -->
<div id="microNav">
  <button id="microNavBtn" type="button" aria-label="Open navigation">⋯</button>
  <div id="microNavMenu" role="menu" aria-label="Site navigation">
    <a href="https://art.jeffgompertz.site/a_mashup_saved_images_v2/">Archive</a>
    <a href="https://art.jeffgompertz.site/gan/">GAN Sandbox</a>
    <a href="https://art.jeffgompertz.site/a_prompt-poem_v9-7_replicate/">A Prompt Poem</a>
  </div>
</div>

<script>
(() => {
  const API_BASE="https://art.jeffgompertz.site";
  const EP_RESIDUE=new URL("/wp-json/ganemulator/v1/residue?limit=120",API_BASE).toString();
  const canvas=document.getElementById("rcCanvas");
  const ctx=canvas.getContext("2d",{alpha:false});
  const btnPlayPause=document.getElementById("rcPlayPause");
  const btnNext=document.getElementById("rcNext");
  const btnRefresh=document.getElementById("rcRefresh");

  const FADE_MS=4200,HOLD_MS=1800,BUFFER_TARGET=12,FETCH_EVERY_MS=45000,TOPUP_EVERY_MS=5000,USE_SCREEN_BLEND=true;
  let running=true,items=[],feed=[],i=0,buffer=[],bufferInfo=[],A=null,B=null,aInfo=null,bInfo=null,phase="fade",t0=performance.now();

  function resize(){const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
    const w=Math.floor(innerWidth*dpr),h=Math.floor(innerHeight*dpr);
    if(canvas.width!==w||canvas.height!==h){canvas.width=w;canvas.height=h;ctx.imageSmoothingEnabled=true;}}
  addEventListener("resize",resize,{passive:true});resize();

  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]];}}
  async function fetchFeed(){try{const r=await fetch(EP_RESIDUE,{cache:"no-store"});const j=await r.json();
    if(!j.ok)throw 0;items=j.items.filter(it=>it.url);feed=items.map(it=>it.url);shuffle(feed);i=0;}catch(e){console.warn("feed fail",e);}}
  async function decodeOne(u){try{const r=await fetch(u,{mode:"cors",cache:"force-cache"});return await createImageBitmap(await r.blob());}
    catch(e){return await new Promise(res=>{const im=new Image();im.crossOrigin="anonymous";im.onload=()=>res(im);im.onerror=()=>res(null);im.src=u;});}}
  function infoForUrl(u){return items.find(x=>x.url===u)||{url:u};}
  async function topUpBuffer(){while(buffer.length<BUFFER_TARGET){const u=feed[i%feed.length];i++;
      if(bufferInfo.some(x=>x.url===u))continue;const bmp=await decodeOne(u);if(!bmp)continue;
      buffer.push(bmp);bufferInfo.push(infoForUrl(u));}}
  function pickNext(){if(buffer.length<2)return;A=B||buffer.shift();aInfo=bInfo||bufferInfo.shift();
    B=buffer.shift();bInfo=bufferInfo.shift();buffer.push(A);bufferInfo.push(aInfo);phase="fade";t0=performance.now();}
  function drawCover(img,a){if(!img)return;const W=canvas.width,H=canvas.height,iw=img.width,ih=img.height;
    const s=Math.max(W/iw,H/ih),dw=iw*s,dh=ih*s,ox=(W-dw)/2,oy=(H-dh)/2;ctx.globalAlpha=a;ctx.drawImage(img,ox,oy,dw,dh);}
  function frame(now){ctx.globalAlpha=1;ctx.globalCompositeOperation="source-over";ctx.fillStyle="#000";ctx.fillRect(0,0,canvas.width,canvas.height);
    if(!A||!B){if(running)requestAnimationFrame(frame);return;}const e=now-t0;
    if(phase==="fade"){const p=Math.min(1,e/FADE_MS),ease=p*p*(3-2*p);ctx.globalCompositeOperation="source-over";drawCover(A,1-ease);
      ctx.globalCompositeOperation=USE_SCREEN_BLEND?"screen":"source-over";drawCover(B,ease);
      if(p>=1){phase="hold";t0=now;}}else{ctx.globalCompositeOperation="source-over";drawCover(B,1);if(e>=HOLD_MS)pickNext();}
    if(running)requestAnimationFrame(frame);}
  btnPlayPause.onclick=()=>{running=!running;btnPlayPause.textContent=running?"⏸":"▶";
    if(running){t0=performance.now();requestAnimationFrame(frame);}};
  btnNext.onclick=()=>{pickNext();if(!running)requestAnimationFrame(frame);};
  btnRefresh.onclick=async()=>{await fetchFeed();await topUpBuffer();if(!A||!B)pickNext();if(!running)requestAnimationFrame(frame);};
  (async()=>{await fetchFeed();await topUpBuffer();pickNext();requestAnimationFrame(frame);
    setInterval(async()=>{await fetchFeed();await topUpBuffer();},FETCH_EVERY_MS);
    setInterval(async()=>{await topUpBuffer();},TOPUP_EVERY_MS);})();
})();

// MicroNav toggle logic
(() => {
  const btn=document.getElementById("microNavBtn"),menu=document.getElementById("microNavMenu");
  if(!btn||!menu)return;
  const close=()=>menu.style.display="none";
  btn.addEventListener("click",(e)=>{e.stopPropagation();
    menu.style.display=(menu.style.display==="block")?"none":"block";});
  document.addEventListener("click",(e)=>{if(!menu.contains(e.target)&&e.target!==btn)close();});
  document.addEventListener("keydown",(e)=>{if(e.key==="Escape")close();});
})();
</script>