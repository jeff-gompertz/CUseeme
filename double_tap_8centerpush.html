<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>8Cards ‚Äî Dense-Center Glass Stack</title>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  canvas { display: block; }
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
/* === Canvas setup === */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener("resize", resize); resize();

/* === Scene keywords === */
const SCENE_KEYWORDS = [["ghost"],["zero"],["bus"],["mask"]];
let currentScene = 0;
const NEXT_PAGE_URL = "nextpage.html";

/* === Load videos === */
async function loadVideos(){
  const MEDIA_API = "https://art.jeffgompertz.site/wp-json/wp/v2/media?per_page=50";
  const FILTER_KEYWORDS = SCENE_KEYWORDS[currentScene];
  try{
    const r = await fetch(MEDIA_API);
    const d = await r.json();
    const filtered = d.filter(m=>{
      const text = ((m.title?.rendered||"")+" "+(m.caption?.rendered||"")+" "+(m.description?.rendered||"")).toLowerCase();
      const url  = (m.source_url||"").toLowerCase();
      const kwHit = FILTER_KEYWORDS.some(k=>text.includes(k)||url.includes(k));
      return m.mime_type?.startsWith("video/") && kwHit;
    });
    console.log(`üéØ Filtered videos for [${FILTER_KEYWORDS.join(", ")}]: ${filtered.length}`);
    const vids=[];
    for(const m of filtered){
      const v=document.createElement("video");
      v.src=m.source_url; v.loop=true; v.muted=true; v.playsInline=true; v.preload="auto";
      v.style.display="none"; document.body.appendChild(v);
      await new Promise(res=>{const ok=()=>res();v.oncanplay=ok;v.onerror=ok;setTimeout(ok,1200);});
      v.play().catch(()=>{});
      vids.push(v);
    }
    return vids;
  }catch(e){console.warn("Video load error:",e);return[];}
}

/* === Autoplay unlock (iOS etc.) === */
function startVideos(){ document.querySelectorAll("video").forEach(v=>v.play().catch(()=>{})); }
addEventListener("touchstart", startVideos, { once:true });
addEventListener("click", startVideos, { once:true });

/* === Card / Panel setup === */
let cards=[];
const NUM_CARDS=8;                 // four per side
const CENTER_PUSH=280;             // tighten center overlap
const STAGGER_X=60;                // horizontal randomness
const STAGGER_Y=50;                // vertical randomness
const DEPTH_JITTER=0.5;            // opacity variance

function initCards(vids){
  const W=canvas.width, H=canvas.height;
  const w=W/2+180;                 // panel width (overlaps more)
  const h=H*1.05;
  cards=[];
  const perSide=NUM_CARDS/2;
  for(let i=0;i<NUM_CARDS;i++){
    const side=i<perSide?"left":"right";
    const idx=i%perSide;
    const inward=(Math.random()-0.5)*STAGGER_X;
    const vertical=(Math.random()-0.5)*STAGGER_Y;
    const t=idx/(perSide-1); // 0‚Üíedge,1‚Üícenter
    let xBase;
    if(side==="left"){
      const edge=-80;                                  // stick to left border
      const center=(W/2-w/2)+CENTER_PUSH/2;            // compressed middle
      xBase=edge+(center-edge)*t+inward;
    }else{
      const edge=W-w+80;                               // stick to right border
      const center=(W/2-w/2)-CENTER_PUSH/2;
      xBase=edge+(center-edge)*t+inward;
    }
    cards.push({
      x:xBase,y:vertical,w,h,side,
      vid:vids.length?vids[i%vids.length]:null,
      alpha:0.25+Math.random()*DEPTH_JITTER,
      dragging:false,offsetX:0,offsetY:0
    });
  }
}

/* === Draw helper === */
function drawVideoCover(v,x,y,w,h,a=1){
  if(!v||v.readyState<2)return;
  const iw=v.videoWidth||v.width, ih=v.videoHeight||v.height;
  const r=Math.max(w/iw,h/ih);
  const nw=iw*r, nh=ih*r;
  const ox=x+(w-nw)/2, oy=y+(h-nh)/2;
  ctx.globalAlpha=a; ctx.drawImage(v,ox,oy,nw,nh); ctx.globalAlpha=1;
}

/* === Fading === */
let activeFades=[];
function triggerFade(card,newVid){activeFades.push({card,oldVid:card.vid,newVid,progress:0});}
async function sequentialFadeReplace(newVids){
  for(const c of cards){
    const newVid=newVids[Math.floor(Math.random()*newVids.length)];
    triggerFade(c,newVid);
    await new Promise(r=>setTimeout(r,700));
  }
}

/* === Scene changer + next-page jump === */
async function nextScene(){
  if(activeFades.length>0)return;
  currentScene++;
  if(currentScene>=SCENE_KEYWORDS.length){
    console.log("üö™ All scenes done ‚Üí jump next page");
    window.location.href=NEXT_PAGE_URL;
    return;
  }
  const newVids=await loadVideos();
  if(newVids.length)sequentialFadeReplace(newVids);
}

/* === Double-tap / Double-click trigger === */
let sceneAdvancing=false, lastTapTime=0;
function handleSceneAdvance(e){
  const now=Date.now(), delta=now-lastTapTime;
  if(delta<400&&!sceneAdvancing){
    sceneAdvancing=true; nextScene().finally(()=>sceneAdvancing=false);
    e.preventDefault();
  }
  lastTapTime=now;
}
canvas.addEventListener("touchstart",handleSceneAdvance,{passive:false});
canvas.addEventListener("click",handleSceneAdvance);

/* === Dragging (viewport constrained) === */
let active=null;
function pointerDown(e){
  const r=canvas.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
  const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
  for(let i=cards.length-1;i>=0;i--){
    const c=cards[i];
    if(x>c.x&&x<c.x+c.w&&y>c.y&&y<c.y+c.h){
      c.dragging=true;c.offsetX=x-c.x;c.offsetY=y-c.y;active=c;break;
    }
  }
}
function pointerMove(e){
  if(!active)return;
  const r=canvas.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
  const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
  active.x=Math.max(-100,Math.min(canvas.width-active.w+100,x-active.offsetX));
  active.y=Math.max(-100,Math.min(canvas.height-active.h+100,y-active.offsetY));
}
function pointerUp(){if(active){active.dragging=false;active=null;}}
canvas.addEventListener("mousedown",pointerDown);
canvas.addEventListener("mousemove",pointerMove);
canvas.addEventListener("mouseup",pointerUp);
canvas.addEventListener("touchstart",pointerDown);
canvas.addEventListener("touchmove",pointerMove);
canvas.addEventListener("touchend",pointerUp);

/* === Render === */
function render(){
  ctx.fillStyle="rgba(0,0,0,0.05)";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for(const c of cards){
    const f=activeFades.find(ff=>ff.card===c);
    if(f){
      f.progress+=0.02; const p=Math.min(1,f.progress);
      drawVideoCover(f.oldVid,c.x,c.y,c.w,c.h,0.35*(1-p*0.8)*(c.alpha||1));
      drawVideoCover(f.newVid,c.x,c.y,c.w,c.h,0.35*p*(c.alpha||1));
      if(p>=1){c.vid=f.newVid;activeFades=activeFades.filter(ff=>ff!==f);}
    }else{
      drawVideoCover(c.vid,c.x,c.y,c.w,c.h,0.35*(c.alpha||1));
    }
  }
  requestAnimationFrame(render);
}

/* === Boot === */
(async()=>{
  const vids=await loadVideos();
  if(!vids.length){console.warn("‚ö†Ô∏è No videos found");return;}
  initCards(vids);
  render();
})();
</script>
</body>
</html>
