<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>6Cards — Scan Accumulate v3 (bugfix)</title>
<style>
  body {margin:0;overflow:hidden;background:#000;}
  canvas {display:block;}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let W = innerWidth, H = innerHeight;
function resize(){ W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H; }
addEventListener("resize",resize); resize();

/* === YouTube RSS thumbnails === */
const FEED_URL = "https://www.youtube.com/feeds/videos.xml?channel_id=UCREEmHdAYvlboosrKCHe4UA";
const RSS_API  = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(FEED_URL);

async function loadThumbs(){
  try{
    const r = await fetch(RSS_API);
    const d = await r.json();
    const items = (d.items||[]).slice(0,6);
    const imgs = [];
    for (const it of items){
      const vid=(it.guid||"").split(":").pop();
      const src=it.thumbnail || `https://i.ytimg.com/vi/${vid}/hqdefault.jpg`;
      const im=new Image(); im.crossOrigin="anonymous";
      await new Promise(res=>{im.onload=res;im.onerror=res;im.src=src;});
      if(im.width) imgs.push(im);
    }
    return imgs;
  }catch(e){console.warn("feed error",e);return [];}
}

/* === Card setup === */
const cards = [];
const cols = 3, rows = 2; // grid reference
let scanSpeed = 1.8;

function makeCards(imgs){
  for(let i=0;i<6;i++){
    const w = 180, h = 110;
    cards.push({w,h,img:imgs[i%imgs.length]});
  }
}

/* Helper: draw image covering rect */
function drawImageCover(img,x,y,w,h){
  const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
  if(!iw||!ih) return;
  const r=Math.max(w/iw,h/ih);
  const nw=iw*r, nh=ih*r;
  const ox=x+(w-nw)/2, oy=y+(h-nh)/2;
  ctx.drawImage(img,ox,oy,nw,nh);
}

/* === Animation === */
let phase=0;
function animate(){
  // ✳️ Controlled background fade
  ctx.globalCompositeOperation='source-over';
  ctx.globalAlpha=0.01;      // soft fade
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,W,H);

  // ✳️ Additive accumulation pass
  ctx.globalCompositeOperation='lighter';
  ctx.globalAlpha=0.05;      // dim additive layer

  const rowHeight = H / rows;
  cards.forEach((c,i)=>{
    if(!c.img) return;
    const row = Math.floor(i / cols);
    const scanX = ((phase * scanSpeed + i * (W/cols)) % (W + c.w)) - c.w;
    const scanY = row * rowHeight + rowHeight/3;
    drawImageCover(c.img, scanX, scanY, c.w, c.h);
  });

  phase += 1;
  requestAnimationFrame(animate);
}

/* === Boot === */
(async function(){
  const imgs = await loadThumbs();
  if(!imgs.length){
    const dummy = new Image(); dummy.src="https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg";
    await new Promise(r=>{dummy.onload=r;});
    makeCards([dummy]);
  } else makeCards(imgs);
  animate();
})();
</script>
</body>
</html>
