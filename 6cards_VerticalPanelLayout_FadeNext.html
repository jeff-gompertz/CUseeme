<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>6Cards — Vertical Diptych Dissolve + Next Scene</title>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  canvas { display: block; touch-action: none; }
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
/* === Canvas setup === */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
let W = innerWidth, H = innerHeight;
function resize(){ W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H; }
window.addEventListener("resize", resize);
resize();

/* === Fade + drift parameters === */
const FADE_SPEED   = 0.015;  // dissolve rate
const MIN_OPACITY  = 0.3;    // how much of old scene remains visible
const DRIFT_SPEED  = 0.6;    // horizontal drift during transition

let currentVids = [], nextVids = [];
let transition = 0;
let isTransitioning = false;

/* === Load WordPress MP4 videos === */
async function loadVideos(){
  const MEDIA_API = "https://art.jeffgompertz.site/wp-json/wp/v2/media?per_page=30";
  try {
    const r = await fetch(MEDIA_API);
    const d = await r.json();
    const vids = d
      .filter(m => m.mime_type === "video/mp4" || /\.mp4$/i.test(m.source_url))
      .map(m => {
        const v = document.createElement("video");
        v.src = m.source_url;
        v.loop = true;
        v.muted = true;
        v.playsInline = true;
        v.preload = "auto";
        v.style.display = "none";
        document.body.appendChild(v);
        return v;
      });
    return vids;
  } catch(err){
    console.warn("Video load error:", err);
    return [];
  }
}

/* === Dragging setup === */
const cards = [];
const NUM_CARDS = 6;
const CARD_W = () => W/2.05;
const CARD_H = () => H;

function initCards(vids){
  cards.length = 0;
  for (let i=0; i<NUM_CARDS; i++){
    const side = i < NUM_CARDS/2 ? "left" : "right";
    const x = (side==="left"?0:W/2) + (Math.random()-0.5)*40;
    cards.push({
      x, y:0, w:CARD_W(), h:CARD_H(),
      vid: vids.length ? vids[i % vids.length] : null,
      dragging:false, dx:0, dy:0
    });
  }
}

/* Pointer → drag controls */
canvas.addEventListener("pointerdown", e=>{
  const {x,y}=getXY(e);
  for(const c of cards){
    if(x>=c.x&&x<=c.x+c.w&&y>=c.y&&y<=c.y+c.h){
      c.dragging=true; c.dx=x-c.x; c.dy=y-c.y;
    }
  }
});
canvas.addEventListener("pointermove", e=>{
  const {x,y}=getXY(e);
  for(const c of cards){
    if(c.dragging){
      c.x=Math.min(Math.max(0,x-c.dx),W-c.w);
      c.y=Math.min(Math.max(0,y-c.dy),H-c.h);
    }
  }
});
canvas.addEventListener("pointerup", ()=>cards.forEach(c=>c.dragging=false));
canvas.addEventListener("pointercancel", ()=>cards.forEach(c=>c.dragging=false));
function getXY(e){return e.touches?.[0]?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};}

/* === Scene advance === */
async function nextScene(){
  if(isTransitioning) return;
  isTransitioning=true;
  nextVids=await loadVideos();
  transition=0;
}

/* === Draw helper === */
function drawVideoCover(vid,x,y,w,h){
  const iw=vid.videoWidth||vid.width, ih=vid.videoHeight||vid.height;
  if(!iw||!ih)return;
  const r=Math.max(w/iw,h/ih);
  const nw=iw*r, nh=ih*r;
  const ox=x+(w-nw)/2, oy=y+(h-nh)/2;
  ctx.drawImage(vid,ox,oy,nw,nh);
}

function drawCards(vids,alpha){
  ctx.globalAlpha=alpha;
  for(const c of cards){
    const vid=vids.length?vids[cards.indexOf(c)%vids.length]:null;
    if(vid && vid.readyState>=2){
      drawVideoCover(vid,c.x,c.y,c.w,c.h);
    }else{
      ctx.fillStyle="rgba(255,255,255,0.15)";
      ctx.fillRect(c.x,c.y,c.w,c.h);
    }
    if(isTransitioning) c.x+=DRIFT_SPEED*(transition-0.5);
  }
  ctx.globalAlpha=1;
}

/* === Animate === */
function animate(){
  ctx.fillStyle="rgba(0,0,0,0.05)";
  ctx.fillRect(0,0,W,H);

  if(!isTransitioning){
    drawCards(currentVids,1);
  }else{
    transition+=FADE_SPEED;
    if(transition>=1){
      currentVids=nextVids;
      nextVids=[];
      isTransitioning=false;
      transition=0;
    }
    const oldAlpha=1-(transition*(1-MIN_OPACITY));
    const newAlpha=transition;
    drawCards(currentVids,oldAlpha);
    drawCards(nextVids,newAlpha);
  }

  requestAnimationFrame(animate);
}

/* === Start all videos on touch/click === */
function startVideos(){
  document.querySelectorAll("video").forEach(v=>v.play().catch(()=>{}));
  console.log("▶️ Videos playback triggered");
}
window.addEventListener("touchstart", startVideos, {once:true});
window.addEventListener("click", startVideos, {once:true});
window.addEventListener("mousedown", nextScene); // click = next set
window.addEventListener("touchstart", nextScene); // tap = next set

/* === Boot === */
(async()=>{
  currentVids=await loadVideos();
  if(!currentVids.length){console.warn("⚠️ No videos found");return;}
  initCards(currentVids);
  animate();
})();
</script>
</body>
</html>
